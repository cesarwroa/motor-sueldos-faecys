
<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>Calculadora de Comercio</title>
<style>
:root{ --bg:#f6f7fb; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --grid:#e2e8f0; }
*{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
.container{max-width:1200px;margin:24px auto;padding:0 16px} .card{background:#fff;border:1px solid var(--grid);border-radius:16px;padding:16px}
.grid{display:grid;gap:12px} .cols-4{grid-template-columns:repeat(4,minmax(0,1fr))} .cols-3{grid-template-columns:repeat(3,1fr)}
label{display:block;font-size:12px;color:#475569;margin-bottom:6px} input,select,button{border:1px solid var(--grid);border-radius:10px;padding:10px;background:white}
button{cursor:pointer} .readonly{background:#f8fafc;color:#0f172a;pointer-events:none;opacity:.9}
.table{width:100%;border-collapse:collapse;border:1px solid var(--grid);border-radius:12px;overflow:hidden}
.table th,.table td{border-bottom:1px solid var(--grid);padding:10px;text-align:left;font-size:14px} .table thead th{background:#f8fafc;font-weight:800}
.note{font-size:12px;color:#334155;background:#f1f5f9;border:1px dashed #cbd5e1;border-radius:10px;padding:8px;margin-top:6px}

.inline-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.inline-hint{font-size:12px;color:#334155}
.km-wrap{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.km-pair{display:flex;align-items:center;gap:6px;white-space:nowrap}

.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eff6ff;color:#1d4ed8;font-weight:700;font-size:12px}
.tabs{display:flex;gap:6px;margin:12px 0} .tab{padding:8px 12px;border:1px solid var(--grid);border-radius:10px;background:#fff;cursor:pointer} .active{border-color:#93c5fd;background:#eff6ff}
.right{text-align:right}
@media print{ .no-print{display:none!important} body{background:#fff} .card{box-shadow:none} .lf-base{display:none!important} }

/* === FORCE FORMAT · MVP exacto + OnePage === */
@page { size: A4; margin: 10mm; } /* área util 190mm x 277mm */
#printArea .sheet { position:relative; width:190mm; min-height:260mm; margin:0 auto; font-family: ui-sans-serif, system-ui, "Segoe UI", Roboto, Arial; color:#0f172a; font-size:11px; }
#printArea .title { font-size:14px; font-weight:700; margin:0 0 3mm 0; }
#printArea .subheader { font-size:11px; color:#475569; margin:0 0 2mm 0; }
#printArea .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 4mm; margin:1.2mm 0; }
#printArea .cell { white-space:nowrap; }
#printArea .label { color:#475569; }
#printArea table { width:190mm; border-collapse:collapse; border:0.3mm solid #d0d7e2; margin-top:3mm; table-layout:fixed; }
#printArea thead th { background:#f1f5f9; font-weight:700; }
#printArea th, #printArea td { padding:1.4mm 2mm; border-bottom:0.3mm solid #e2e8f0; vertical-align:top; }
#printArea td.right, #printArea th.right { text-align:right; white-space:nowrap; }
#printArea tfoot td { font-weight:800; }
#printArea .neto { font-size:13px; font-weight:900; }
#printArea .foot { display:grid; grid-template-columns: 1fr 1fr; gap:6mm; margin-top:5mm; align-items:start; }
#printArea .firmaBox { border-top:0.3mm solid #94a3b8; padding-top:2mm; text-align:center; }
#printArea .sigBlock { border:0.3mm solid #cbd5e1; border-radius:2mm; padding:2mm 3mm; }
#printArea .sigTitle { font-weight:700; margin-bottom:1mm; }
#printArea .qr { width:32mm; height:32mm; border:0.3mm dashed #94a3b8; display:flex; align-items:center; justify-content:center; font-size:10px; color:#64748b; }

/* === Base (solo HTML) === */
.th-base-num, .col-base-num { min-width: 180px; }
.base-mini { font-size: 12px; opacity:.95; }
@media print { .th-base-num, .col-base-num, #co-toggle-base-num { display:none !important; } }

/* Toggle columnas Base (Ver base) */
.hide-base-col .th-base-num, .hide-base-col .col-base-num { display:none !important; }
.hide-base-final .lf-base { display:none !important; }
</style>
<style>
#co-inline-panel *{box-sizing:border-box}
#co-inline-panel input, #co-inline-panel select{max-width:100%}
#co-inline-panel > div:first-child{justify-self:start}
#co-inline-panel{justify-items:start}
</style>
<style>
#co-inline-panel{max-width:calc(100% - 8px); overflow:hidden;}
#co-inline-panel *{box-sizing:border-box}
#co-inline-panel input, #co-inline-panel select{max-width:100%}
#co-inline-panel > div{min-width:0}
#co-inline-panel > div:first-child{justify-self:start}
#co-inline-panel{justify-items:start; column-gap:10px; row-gap:10px}
#co-inline-panel .co-emb-row{display:grid; grid-template-columns:70px 1fr 90px; gap:8px}
@media (max-width: 1100px){
  #co-inline-panel{grid-template-columns:repeat(4, minmax(160px, 1fr));}
}
@media (max-width: 900px){
  #co-inline-panel{grid-template-columns:repeat(3, minmax(160px, 1fr));}
  #co-inline-panel .co-emb-row{grid-template-columns:60px 1fr 90px;}
}
</style>
<style>
/* Turismo title row full width and spacing */
#co-inline-panel .co-turismo { grid-column: 1 / -1 !important; margin-top: 6px; }
</style>
<style>
/* Centrado/estilo fila Total */
tr.co-total-row > td { vertical-align: middle; }
tr.co-total-row > td:first-child { font-weight: 700; }
</style>
<!-- Estilo responsivo específico para el panel de licencias/ausencias en dispositivos pequeños -->
<style id="co-inline-responsive">
  @media (max-width: 768px) {
    /* Forzar una sola columna en el panel de licencias y ausencias */
    #co-inline-panel {
      grid-template-columns: 1fr !important;
    }
    /* Asegurar que los controles ocupen todo el ancho */
    #co-inline-panel input,
    #co-inline-panel select {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box;
    }
  }
</style>
<style>
/* CO: Ocultar números hasta presionar Calcular */
.co-masked{color:transparent !important; text-shadow:none !important;}
</style>
</head>
<body>
<div class="container">
<h1>Calculadora de Comercio</h1>
<div class="tabs no-print">
<div class="tab active" id="tabMensual" onclick="switchTab('mensual')">Mensual</div>
<div class="tab" id="tabFinal" onclick="switchTab('final')">Liquidación Final</div>
</div>
<div class="card">
<div class="grid cols-4">
<div><label>Rama</label><select id="rama"></select></div>
<div id="agrupWrap"><label>Agrupamiento</label><select id="agrup"></select></div>
<div><label>Categoría</label><select id="categoria"></select></div>
<div><label>Mes</label><select id="mes"></select></div>
</div>
<div class="note" id="status">Cargando maestro…</div>
</div>
<div class="card" id="paneMensual">
<div class="grid cols-4"><div><label>Básico (Rem) — auto</label><input class="readonly" disabled="" id="basico" readonly="" step="0.01" type="number" value="0"/></div><div><label><span id="lblNrVar">No Rem (variable)</span> — auto</label><input class="readonly" disabled="" id="nrVar" readonly="" step="0.01" type="number" value="0"/></div><div><label><span id="lblNrSF">Suma Fija (NR)</span> — auto</label><input class="readonly" disabled="" id="nrSF" readonly="" step="0.01" type="number" value="0"/></div><div><label>A cuenta futuros aumentos (REM)</label><input id="aCuentaNR" step="0.01" type="number" value="0"/></div><div><label>Fecha de alta</label><input id="alta" type="date"/></div><div><label>Años de antigüedad</label><input id="anios" min="0" type="number" value="0"/></div><div id="hsWrap"><label>Jornada</label><input id="hs" max="48" min="1" type="number" value="48"/></div><div><label>NR Total (auto)</label><input class="readonly" disabled="" id="nrTotal" readonly="" step="0.01" type="number" value="0"/></div></div>
<div id="mensualExtrasHost"><div id="mensualExtrasRoot">
<div class="note" id="aguaBlock" style="display:none">
  <strong>Agua Potable:</strong> Conexiones
  <span style="margin-left:6px">Cantidad:</span>
  <input id="aguaConexiones" type="number" min="0" step="1" value="0" style="max-width:120px; margin-left:4px"/>
  <span style="margin-left:8px">Categoría:</span>
  <select id="aguaConexCat" style="max-width:180px; margin-left:4px">
    <option value="">—</option>
    <option value="A">A (hasta 500)</option>
    <option value="B">B (+7% s/A)</option>
    <option value="C">C (+7% s/B)</option>
    <option value="D">D (+7% s/C)</option>
  </select>
  <div id="aguaConexInfo" style="margin-top:6px; color:#64748b"></div>
</div>
<div class="note" id="funBlock" style="display:none">
  <strong>Fúnebres:</strong> Adicionales mensuales
  <div id="funList" class="grid cols-4" style="margin-top:6px"></div>
  <div id="funHint" style="margin-top:6px; color:#64748b"></div>
</div>
<div class="grid cols-4" style="margin-top:8px"><div><label>Armado de vidriera</label> <label style="margin-left:6px"><input id="armadoAuto" type="checkbox"/> auto</label></div><div><label>Adicional por KM</label><div class="km-wrap"><span>Categoría:</span> <select id="kmTipo" style="max-width:160px"><option value="">--</option><option value="AY">Ayudante</option><option value="CH">Chofer</option></select> <div class="km-pair"><span>km menor o igual a 100 km:</span> <input id="kmMenos100" min="0" step="1" style="max-width:110px" type="number" value="0"/></div> <div class="km-pair"><span>km más de 100 km:</span> <input id="kmMas100" min="0" step="1" style="max-width:110px" type="number" value="0"/></div></div></div><div id="boxTitulo" style="display:none"><label>Adicional por Título (Turismo)</label><select id="turTitulo"><option value="0">Sin título</option><option value="2.5">Terciario (2,5%)</option><option value="5">Licenciatura (5%)</option></select></div><div><label>Viáticos (NR sin aportes)</label><input id="viaticosNR" step="0.01" type="number" value="0"/></div><div><label>Zona desfavorable</label><select id="zona">
<option value="0">Sin zona (0%)</option><option value="5">5%</option><option value="20">20%</option><option value="35">35%</option><option value="80">80%</option>
</select></div><div><label>OSECAC</label><select id="osecac"><option value="true">Sí (3% NR + $100)</option><option value="false">No</option></select></div></div>
<div class="grid cols-4" style="margin-top:8px"><div><label>Manejo de Caja (opcional)</label><div class="inline-row"><input id="manejoCaja" type="checkbox"/> <select id="cajero_tipo" style="max-width:120px"><option value="">Tipo</option><option value="A">A (12,25%)</option><option value="B">B (48%)</option><option value="C">C (12,25%)</option></select><span class="inline-hint">A/C 12,25% base Cajeros A · B 48% base Cajeros B (anual, /12).</span></div></div><div><label for="faltanteCajaInput">Faltante de caja (desc.)</label><input id="faltanteCajaInput" min="0" step="0.01" type="number" value="0"/></div><div><label>Horas extra 50% (cant.)</label><input id="hex50" min="0" step="0.25" type="number" value="0"/></div><div><label>Horas extra 100% (cant.)</label><input id="hex100" min="0" step="0.25" type="number" value="0"/></div></div>
<div class="grid cols-4" style="margin-top:8px">
<div><label>Horas nocturnas (cant.)</label><input id="hsNoct" min="0" step="0.25" type="number" value="0"/></div>
<div><label>Adelanto de sueldo (desc.)</label><input id="adelantoSueldo" min="0" step="0.01" type="number" value="0"/></div>
</div>
<div class="grid cols-4" style="margin-top:8px">
<div><label>Feriados no trabajados (días)</label><input id="ferNoTrab" min="0" step="1" type="number" value="0"/></div>
<div><label>Feriados trabajados (días)</label><input id="ferTrab" min="0" step="1" type="number" value="0"/></div>
<div><label>Afiliado sindicato</label><div><input id="afiliado" type="checkbox"/> <select id="afiliado_selector" style="max-width:140px"><option value="NO">No afiliado</option><option value="1">Afiliado 1%</option><option value="2">Afiliado 2%</option><option value="3">Afiliado 3%</option><option value="4">Afiliado 4%</option></select> <span style="margin-left:6px">+ fijo</span> <input id="afiliado_fijo" min="0" step="0.01" style="max-width:100px" type="number" value="0"/> Afiliado</div></div>
</div>
<div class="note" id="licenciasBox" style="margin-top:8px">

<div class="grid cols-4" style="margin-top:8px">
<div>
<label>Jubilado</label>
<div><input id="coJub" type="checkbox"/></div>
</div>
<div><label>Vacaciones gozadas (días)</label><input id="coVacGoz" min="0" step="1" type="number" value="0"/></div>
<div><label>Licencia con goce (días)</label><input id="coLicCG" min="0" step="1" type="number" value="0"/></div>
<div><label>Licencia sin goce / suspensión (días)</label><input id="coLicSG" min="0" step="1" type="number" value="0"/></div>
</div>
<div class="grid cols-4" style="margin-top:8px">
<div>
<label>Es suspensión</label>
<div><input id="coSuspension" type="checkbox"/></div>
</div>
<div><label>Ausencias injustificadas (días)</label><input id="coAus" min="0" step="1" type="number" value="0"/></div>
<div><label>Embargo (monto)</label><input id="coEmbargo" min="0" step="0.01" type="number" value="0"/></div>
</div>
</div></div>
<!--MENSUAL_EXTRAS_END-->
<div class="no-print" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
<button onclick="calcularMensual()" type="button">Calcular mensual</button>
<button onclick="imprimirPDF('mensual')" type="button">Imprimir / PDF</button><label style="display:flex;align-items:center;gap:6px;margin-left:8px"><input id="toggleBaseMensual" type="checkbox"/> Ver base</label>
<span id="diagMensual" style="color:#64748b"></span>
</div>
<div class="badge" style="margin-top:8px">Recibo Mensual</div>


<div style="margin:6px 0;color:#64748b">Rama: <span id="outRama">–</span> · Agrup: <span id="outAgrup">–</span> · Cat: <span id="outCat">–</span> · <span id="outEscala"></span></div>
<div class="table-wrapper">
<table class="table">
<thead><tr><th>Concepto</th><th class="right col-base-num">Base</th><th class="right">Remunerativo</th><th class="right">No Remunerativo</th><th class="right">Descuentos</th></tr></thead>
<tbody id="tbodyMensual"></tbody>
<tfoot>
<tr>
<td>Total</td>
<td class="right col-base-num"></td>
<td class="right" id="totRem">$0,00</td>
<td class="right" id="totNR">$0,00</td>
<td class="right" id="totDed">$0,00</td>
</tr>
<tr>
<td class="right" colspan="4"><strong>Neto a cobrar</strong></td>
<td class="right" id="neto">$0,00</td>
</tr>
</tfoot>
</table>
</div>
</div>

</div><!-- FIX: cierre paneMensual para que Liquidación Final sea visible -->
<div class="card" id="paneFinal" style="display:none">
<div class="grid cols-4">
<div><label>Fecha de ingreso</label><input id="lf_ingreso" type="date"/></div>
<div><label>Fecha de egreso</label><input id="lf_egreso" type="date"/><div class="note"><label><input checked="" id="lf_use_lastday" type="checkbox"/> Usar último día del mes si está vacío</label></div></div>
<div><label>Años para art. 245 (auto)</label><input class="readonly" disabled="" id="lf_anios" min="0" readonly="" type="number" value="0"/></div>
<div id="lf_hsWrap"><label>Jornada</label>
  <input id="lf_hs" type="number" min="1" max="48" value="48" list="lf_hs_list"/>
  <datalist id="lf_hs_list">
    <option value="48"></option>
    <option value="45"></option>
    <option value="44"></option>
    <option value="42"></option>
    <option value="40"></option>
    <option value="39"></option>
    <option value="38"></option>
    <option value="37"></option>
    <option value="36"></option>
    <option value="35"></option>
    <option value="34"></option>
    <option value="33"></option>
    <option value="32"></option>
    <option value="30"></option>
    <option value="28"></option>
    <option value="27"></option>
    <option value="24"></option>
    <option value="21"></option>
    <option value="20"></option>
    <option value="18"></option>
    <option value="16"></option>
    <option value="12"></option>
    <option value="6"></option>
  </datalist>
</div>
<div><label>MEJOR SALARIO (editable)</label><input id="lf_mrmnh" min="0" step="0.01" type="number" value="0"/></div>
</div>
<div class="note" id="lf_aguaBlock" style="display:none; margin-top:6px">
  <strong>Agua Potable:</strong> Conexiones
  <span style="margin-left:6px">Cantidad:</span>
  <input id="lf_aguaConexiones" type="number" min="0" step="1" value="0" style="max-width:120px; margin-left:4px"/>
  <span style="margin-left:8px">Categoría:</span>
  <select id="lf_aguaConexCat" style="max-width:180px; margin-left:4px">
    <option value="">—</option>
    <option value="A">A (hasta 500)</option>
    <option value="B">B (+7% s/A)</option>
    <option value="C">C (+7% s/B)</option>
    <option value="D">D (+7% s/C)</option>
  </select>
  <div id="lf_aguaConexInfo" style="margin-top:6px; color:#64748b"></div>
</div>
<div class="grid cols-4" style="margin-top:8px">
<div><div class="campo tipo-lf">
<label for="lf_tipo">Tipo de liquidación</label>
<select id="lf_tipo">
<option value="DESPIDO_SC">Despido sin causa</option>
<option value="DESPIDO_CC">Despido con causa</option>
<option value="RENUNCIA">Renuncia</option>
<option value="FALLECIMIENTO">Fallecimiento</option>
</select>
</div>
<label>Preaviso</label><select id="lf_preaviso"><option value="0">Sin preaviso</option><option value="15">15 días</option><option value="30">1 mes</option><option value="60">2 meses</option></select></div>
<div><label>Integración del mes</label><input checked="" id="lf_integracion" type="checkbox"/> Calcular automático</div>
<div><label>SAC sobre preaviso</label><input id="lf_sac_pre" type="checkbox"/></div>
<div><label>SAC sobre integración</label><input checked="" id="lf_sac_int" type="checkbox"/></div>
</div>
<div class="grid cols-4" style="margin-top:8px">
<div><label>Días trabajados del mes (auto)</label><input id="lf_dias_mes" class="readonly" disabled readonly max="31" min="0" type="number" value="0"/></div>
<div><label>Vacaciones anuales (auto/edi.)</label><input id="lf_vac_anuales" min="0" type="number" value="14"/></div>
<div><label>Vacaciones no gozadas (días)</label><input id="lf_vac_no_goz" min="0" step="0.01" type="number" value="0"/></div>
<div><label>NR incluidos en todas las bases</label><input checked="" disabled="" type="checkbox"/></div>
</div>
<details class="note" id="lf_extras_details" style="margin-top:8px">
  <summary style="cursor:pointer; font-weight:800">Extras del mes de baja</summary>
  <div id="lfExtrasHost" style="margin-top:8px"></div>
</details>

<div class="note small">MEJOR SALARIO se sugiere automáticamente con Básico + NR + Antigüedad + Presentismo (editable).</div>
<div class="no-print" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
  <button onclick="calcularFinal()" type="button">Calcular liquidación final</button>
  <button onclick="imprimirPDF('final')" type="button">Imprimir / PDF</button>
  <label style="display:flex;align-items:center;gap:6px;margin-left:8px"><input id="toggleBaseFinal" type="checkbox"/> Ver base</label>
  <span id="diagFinal" style="color:#64748b"></span>
</div>
<div class="badge" style="margin-top:8px">Liquidación Final</div>
<div style="margin:6px 0;color:#64748b">Rama: <span id="lf_outRama">–</span> · Agrup: <span id="lf_outAgrup">–</span> · Cat: <span id="lf_outCat">–</span> · Ingreso: <span id="lf_outIngreso">–</span> · Egreso: <span id="lf_outEgreso">–</span></div>
<div class="table-wrapper">
<table class="table">
<thead><tr><th>Concepto</th><th class="right">Remunerativo</th><th class="right">No Remunerativo / Indemnizatorio</th><th class="right">Descuentos</th></tr></thead>
<tbody id="tbodyFinal"></tbody>
<tfoot>
<tr><td>Total</td><td class="right" id="lf_totRem">$0,00</td><td class="right" id="lf_totNRI">$0,00</td><td class="right" id="lf_totDed">$0,00</td></tr>
<tr><td class="right" colspan="3"><strong>Neto a cobrar</strong></td><td class="right" id="lf_neto">$0,00</td></tr>
</tfoot>
</table>
</div>
</div>
</div>
<div id="printArea" style="display:none"></div>
<style id="printIsolation">
@page{size:A4;margin:8mm}
@media print{
  body > *:not(#printArea){ display:none !important }
  #printArea{ display:block !important }
  html,body{ background:#fff !important }
}
#printArea{display:none}
/* Hoja simple */
#printArea .sheet{position:relative;width:190mm;min-height:260mm;margin:0 auto;color:#0f172a;font:11px/1.28 ui-sans-serif,system-ui,"Segoe UI",Roboto,Arial}
#printArea tr{break-inside:avoid;page-break-inside:avoid}
#printArea thead{display:table-header-group}
#printArea tfoot{display:table-footer-group}
#printArea .sheet.compact{font:10px/1.18 ui-sans-serif,system-ui,"Segoe UI",Roboto,Arial}
#printArea .sheet.compact .title{font-size:15px;margin-bottom:4.5mm}
#printArea .sheet.compact thead th{padding:1.8mm 1.6mm 1.8mm}
#printArea .sheet.compact th,#printArea .sheet.compact td{padding:1.55mm 1.6mm}
#printArea .sheet.compact .neto{font-size:12.4px}

/* Título */
#printArea .title{text-align:center;font-weight:900;font-size:16px;margin-bottom:6mm}
/* Tabla con columnas fijas y números tabulares */
#printArea table{width:100%;border-collapse:collapse;table-layout:fixed}
#printArea thead th{padding:2.2mm 2mm 2mm;border-bottom:.45mm solid #000;font-weight:800}
#printArea th,#printArea td{padding:2mm;font-variant-numeric:tabular-nums}
#printArea th:nth-child(1),#printArea td:nth-child(1){text-align:left}
#printArea th:not(:first-child),#printArea td:not(:first-child){text-align:right;white-space:nowrap}
#printArea col.wFixed{width:33.5mm}
/* Divisor */
#printArea .divider td{padding:0;border-bottom:.35mm solid #000;height:0}
/* Totales y Neto */
#printArea tfoot td{padding:2.2mm 2mm;border-top:.45mm solid #000;font-weight:800}
#printArea .neto{margin-top:2.6mm;text-align:center;font-size:13.2px;font-weight:900}
/* Pie simple */
#printArea .foot-final{display:grid;grid-template-columns:1fr 1fr;gap:25mm;margin-top:12mm}
#printArea .firma{border-top:.35mm solid #0f172a;text-align:center;padding-top:6mm;height:22mm}
</style>
<!-- CO v97 patch (light listeners) -->
<style>
  /* Mejoras de layout para la columna de auditoría */
  .co-audit-col{ white-space: normal !important; overflow-wrap: anywhere; }
  table{ table-layout: auto; }

@media print{#co-audit-bar{display:none!important}}
</style>
<!-- CO patch v7: dedup de filas, fix ausencia rem-only /30, caída presentismo 2+, recalculo neto inmediato, alineación total -->
<!-- co-base-rs-override-v1: fuerza misma base para FAECYS / Sindicato / Obra Social -->
<!-- Ghost select cleaner: oculta selects vacíos sin id que aparecen como duplicados de Mes -->
<style>
    /* Responsive design for mobile devices */
    /* For phones (≤600px), stack grid columns and adjust form elements */
    @media (max-width: 600px) {
      /* Stack all grid layouts to a single column */
      .grid,
      .cols-4,
      .cols-3 {
        grid-template-columns: 1fr !important;
      }
      /* Increase readability of form controls */
      label,
      input,
      select,
      button {
        font-size: 14px;
        padding: 8px;
      }
      /* Ensure form controls fill the available width on small screens */
      input,
      select,
      textarea,
      button {
        width: 100%;
        max-width: 100%;
        display: block;
      }
      /* Hide decorative watermark on small screens */
      .co-watermark {
        display: none;
      }
      /* Ensure table columns don't collapse too narrow */
      .table th,
      .table td {
        min-width: 120px;
      }

    /* Para el panel de licencias y ausencias (co-inline-panel) usar una sola columna en móviles
       de modo que las casillas de Licencia paga, Licencia sin goce, Vacaciones gozadas,
       Ausencias injustificadas y Embargo se vean una debajo de otra.  Sin esta regla, el grid
       mantiene tres columnas (160px mínimas) que no caben en pantallas angostas y provoca
       que algunos campos queden fuera de vista. */
    #co-inline-panel {
      grid-template-columns: 1fr !important;
    }
    /* El contenedor de embargo mantiene su propio grid interno sin cambios */
    }
    /* On small tablets (601–900px), use two columns */
    @media (min-width: 601px) and (max-width: 900px) {
      .cols-4 {
        grid-template-columns: repeat(2, 1fr) !important;
      }
      .cols-3 {
        grid-template-columns: repeat(2, 1fr) !important;
      }
    }
    /* Wrapper for tables to enable horizontal scrolling on narrow screens */
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
  </style>

<script>
(() => {
  const API_BASE = (window.API_BASE || "").trim() || window.location.origin;

  const $ = (id) => document.getElementById(id);
  const setText = (id, txt) => { const el=$(id); if(el) el.textContent = txt ?? ""; };
  const setVal = (id, v) => { const el=$(id); if(el) el.value = (v ?? "").toString(); };
  const num = (v) => {
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  };
  const money = (v) => {
    const n = num(v);
    return n.toLocaleString("es-AR", { style:"currency", currency:"ARS", minimumFractionDigits:2, maximumFractionDigits:2 });
  };

  // Parseo tolerante para importes ingresados con formato argentino: $ 1.234,56
  const parseMoneyText = (s) => {
    try{
      const raw = (s ?? "").toString().trim();
      if(!raw) return 0;
      const cleaned = raw
        .replace(/[^0-9,.-]/g, "")
        .replace(/\.(?=\d{3}(\D|$))/g, "") // quita separadores de miles
        .replace(",", ".");
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : 0;
    }catch{ return 0; }
  };

  // Compat: algunos bloques viejos usan parseMoneyInput
  const parseMoneyInput = (s) => parseMoneyText(s);

  // Parseo de fecha YYYY-MM-DD como fecha local (evita corrimiento por timezone al usar new Date('YYYY-MM-DD'))
  function parseYMDLocal(s){
    try{
      const raw = (s ?? "").toString().trim();
      const m = raw.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})$/);
      if(!m) return new Date(raw);
      const y = parseInt(m[1], 10);
      const mo = parseInt(m[2], 10) - 1;
      const d = parseInt(m[3], 10);
      return new Date(y, mo, d);
    }catch(_){
      return new Date(s);
    }
  }

  // ===== Impresión / PDF: nombre sugerido del archivo =====
  // Al usar window.print(), Chrome suele sugerir como nombre del PDF el document.title.
  let __coTitleBeforePrint = null;

  function coMonthYearLabel(ym){
    // ym esperado: YYYY-MM  ->  MM-YYYY
    if(typeof ym === 'string' && /^\d{4}-\d{2}$/.test(ym)) return ym.slice(5,7) + '-' + ym.slice(0,4);
    return (ym || '').toString();
  }

  function coSanitizeFilename(name){
    try{
      const s = (name || '').toString()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/[\\/:"*?<>|]+/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
      return s.length > 140 ? s.slice(0, 140).trim() : s;
    }catch(_){
      return (name || '').toString().replace(/\s+/g,' ').trim();
    }
  }

  function buildPrintFilename(tab){
    const t = (tab || 'mensual');
    const app = 'Calculadora de Comercio';
    const rama = ($('rama')?.value || '').toString().trim();
    const cat = ($('categoria')?.value || '').toString().trim();
    const hs = ($('hs')?.value || '').toString().trim();
    const mes = ($('mes')?.value || '').toString().trim();
    const my = coMonthYearLabel(mes);

    if(t === 'final'){
      const fi = (fmtDateISO($('lf_ingreso')?.value || '') || '').toString().split('/').join('-');
      const fe = (fmtDateISO($('lf_egreso')?.value || '') || '').toString().split('/').join('-');
      return coSanitizeFilename(`Liquidacion Final ${app} ${rama} ${cat} ${hs}hs ${my} Ingreso ${fi} Egreso ${fe}`);
    }

    return coSanitizeFilename(`Mensual ${app} ${rama} ${cat} ${hs}hs ${my}`);
  }


  async function fetchJSON(url){
    const res = await fetch(url, { credentials:"omit" });
    const txt = await res.text();
    let data = null;
    try { data = txt ? JSON.parse(txt) : null; } catch { data = txt; }
    if(!res.ok){
      const msg = (data && data.detail) ? JSON.stringify(data) : (typeof data === "string" ? data : res.statusText);
      throw new Error(`HTTP ${res.status} ${msg}`);
    }
    return data;
  }

// Manejo de Caja UI (Etapa 7): habilita/deshabilita inputs y limpia valores si se apaga
function toggleManejoCajaUI(){
  const on = !!($('manejoCaja')?.checked);
  if($('cajero_tipo')) $('cajero_tipo').disabled = !on;
  if($('faltanteCajaInput')) $('faltanteCajaInput').disabled = !on;
  if(!on){
    if($('cajero_tipo')) $('cajero_tipo').value = '';
    if($('faltanteCajaInput')) $('faltanteCajaInput').value = '';
  }
}

  function fillSelect(sel, items, placeholder="—"){
    if(!sel) return;
    const cur = sel.value;
    sel.innerHTML = "";

    // Placeholder: value vacío para no chocar con valores reales como "—"
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder;
    sel.appendChild(opt0);

    (items||[]).forEach((it) => {
      const o = document.createElement("option");
      o.value = it;
      o.textContent = it;
      sel.appendChild(o);
    });

    // Mantener selección si existe; si no, seleccionar el primer ítem real
    if(items && items.length){
      if(items.includes(cur)) sel.value = cur;
      else sel.value = items[0];
    }else{
      sel.value = "";
    }
    $('manejoCaja')?.addEventListener('change', toggleManejoCajaUI);
    toggleManejoCajaUI();
  }


  let META = null;
  let ALL_MESES = [];

  function normRama(r){
    try{
      return (r||"").toString().toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
    }catch{
      return (r||"").toString().toUpperCase().trim();
    }
  }

  // Etiquetas cortas para los adicionales de Fúnebres (solo visual)
  function prettifyFunLabel(raw){
    const s = (raw ?? "").toString().trim();
    if(!s) return "";

    const up = s.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    // Mapeo a los nombres que usás en el modelo de referencia
    if(up.includes("GENERAL") && up.includes("TODO EL PERSONAL")) return "Manipulación de cadáveres";
    if(up.includes("PERSONAL NO INCLUIDO") || up.includes("INCISO 1")) return "Resto del personal";
    if(up.includes("CHOFER") || up.includes("FURGONERO")) return "Chofer/Furgonero";
    if(up.includes("INDUMENTARIA")) return "Indumentaria";

    // Fallback genérico
    return s.replace(/^Adicional\s+/i, "").replace(/\s*\([^)]*\)\s*/g, " ").trim();
  }

  function mesesPorRama(rama){
    const r = normRama(rama);
    // Reglas pedidas (Etapa 2):
    // - GENERAL / FUNEBRES / AGUA / CALL: 2026-01 a 2026-04
    // - TURISMO: 2026-01 a 2026-05
    // - CEREALES: 2026-01 a 2026-03
    if(r === "TURISMO") return ["2026-01","2026-02","2026-03","2026-04","2026-05"];
    if(r === "CEREALES") return ["2026-01","2026-02","2026-03"];
    if(r === "GENERAL") return ["2026-01","2026-02","2026-03","2026-04"];
    if(r === "FUNEBRES" || r === "FUNEBRE") return ["2026-01","2026-02","2026-03","2026-04"];
    if(r === "AGUA POTABLE" || r === "AGUA" || r === "AGUAPOTABLE") return ["2026-01","2026-02","2026-03","2026-04"];
    if(r === "CALL CENTER" || r === "CENTRO DE LLAMADAS" || r === "CENTRO DE LLAMADA" || r === "CALL") return ["2026-01","2026-02","2026-03","2026-04"];
    // Fallback: desde 2026-01 en adelante (hasta lo disponible)
    return (ALL_MESES||[]).filter(m => /^2026-/.test(m));
  }

  function refreshMesesForRama(rama){
    const pref = mesesPorRama(rama);
    const disponibles = (pref||[]).filter(m => (ALL_MESES||[]).includes(m));
    fillSelect($("mes"), disponibles, "Mes");
    const sel = $("mes");
    if(!sel) return;
    // si no quedó seleccionado, usar el último disponible
    if(!sel.value && disponibles.length){
      sel.value = disponibles[disponibles.length-1];
    }
  }




  function isAguaRama(r){
    const rr = normRama(r);
    return rr === 'AGUA POTABLE' || rr === 'AGUA' || rr === 'AGUAPOTABLE';
  }

  function isTurismoRama(r){
    return normRama(r) === 'TURISMO';
  }

  function isFunebresRama(r){
    const rr = normRama(r);
    return rr === 'FUNEBRES' || rr === 'FÚNEBRES' || rr === 'FUNEBRES '; // tolerante
  }

  function clearFunebresAdics(){
    const box = document.getElementById('funList');
    if(box) box.innerHTML = '';
    setText('funHint', '');
  }

  async function loadFunebresAdicionales(){
    try{
      const rama = document.getElementById('rama')?.value || '';
      const mes = document.getElementById('mes')?.value || '';
      if(!isFunebresRama(rama) || !/^\d{4}-\d{2}$/.test(mes)){
        clearFunebresAdics();
        return;
      }

      const rows = await fetchJSON(`${API_BASE}/adicionales-funebres?mes=${encodeURIComponent(mes)}`);
      const box = document.getElementById('funList');
      if(!box) return;
      box.innerHTML = '';

      if(!Array.isArray(rows) || rows.length === 0){
        setText('funHint', 'No hay adicionales configurados para ese mes.');
        return;
      }

      // Render checkboxes
      for(const it of rows){
        const id = (it && it.id != null) ? String(it.id) : '';
        const label = (it && it.label != null) ? String(it.label) : id;
        const tipo = (it && it.tipo != null) ? String(it.tipo).toLowerCase() : '';
        const monto = num(it?.monto);
        const pct = num(it?.pct);
        const obs = (it && it.obs) ? String(it.obs) : '';

        const wrap = document.createElement('label');
        wrap.style.display = 'flex';
        wrap.style.alignItems = 'flex-start';
        wrap.style.gap = '6px';
        wrap.style.lineHeight = '1.2';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = id;

        const txt = document.createElement('div');
        const meta = (tipo === 'monto' && monto) ? `($ ${money(monto).replace('$','').trim()})` : (pct ? `(${pct}%)` : '');
        const prettyLabel = prettifyFunLabel(label);
        txt.innerHTML = `<div>${escapeHtml(prettyLabel)} <span style="color:#64748b">${escapeHtml(meta)}</span></div>` + (obs ? `<div style="color:#64748b; font-size:12px">${escapeHtml(obs)}</div>` : '');

        wrap.appendChild(cb);
        wrap.appendChild(txt);
        box.appendChild(wrap);
      }

      setText('funHint', 'Marcá los adicionales que correspondan.');
    }catch(err){
      console.error(err);
      setText('funHint', 'No se pudieron cargar los adicionales de Fúnebres.');
    }
  }

  // Agua Potable: conexiones (cantidad -> categoría y %)
  async function updateAguaConexInfo(){
    try{
      const rama = $('rama')?.value || '';
      if(!isAguaRama(rama)) return;
      if(window.__aguaConexLock) return;
      window.__aguaConexLock = true;

      const qtyMEl = document.getElementById('aguaConexiones');
      const qtyFEl = document.getElementById('lf_aguaConexiones');
      const selMEl = document.getElementById('aguaConexCat');
      const selFEl = document.getElementById('lf_aguaConexCat');

      let qtyM = qtyMEl ? parseInt(qtyMEl.value || '0', 10) : 0;
      let qtyF = qtyFEl ? parseInt(qtyFEl.value || '0', 10) : 0;
      if(!isFinite(qtyM)) qtyM = 0;
      if(!isFinite(qtyF)) qtyF = 0;

      // Sincronizar cantidades (prioriza la que sea >0)
      let qty = 0;
      if(qtyF > 0) qty = qtyF;
      else if(qtyM > 0) qty = qtyM;

      if(qtyMEl && String(qtyMEl.value||'0') !== String(qty)) qtyMEl.value = String(qty);
      if(qtyFEl && String(qtyFEl.value||'0') !== String(qty)) qtyFEl.value = String(qty);

      const nivel = (selFEl?.value || selMEl?.value || '').trim();

      const params = new URLSearchParams();
      if(qty > 0) params.set('cantidad', String(qty));
      else if(nivel) params.set('nivel', nivel);
      else{
        setText('aguaConexInfo','');
        setText('lf_aguaConexInfo','');
        return;
      }

      const url = new URL(`${API_BASE}/regla-conexiones`);
      url.search = params.toString();
      const regla = await fetchJSON(url.toString());

      const cat = (regla && regla.cat) ? String(regla.cat) : '';
      const pct = (regla && typeof regla.pct === 'number') ? (regla.pct * 100.0) : 0.0;

      if(cat){
        if(selMEl) selMEl.value = cat;
        if(selFEl) selFEl.value = cat;
      }

      const qtyTxt = qty > 0 ? ` (${qty})` : '';
      const txt = cat ? `Adicional por conexiones${qtyTxt} – Categoría ${cat}: +${pct.toFixed(2)}%` : '';
      setText('aguaConexInfo', txt);
      setText('lf_aguaConexInfo', txt);
    }catch(err){
      console.warn('updateAguaConexInfo', err);
    }finally{
      window.__aguaConexLock = false;
    }
  }


  
  function isCallRama(rama){
    const r = normRama(rama);
    return (r === "CALL CENTER" || r === "CENTRO DE LLAMADAS" || r.includes("CALL"));
  }

  function parseHorasCategoria(cat){
    const s = (cat || "").toString().toUpperCase();
    const m = s.match(/(\d+(?:[\.,]\d+)?)\s*H/);
    if(!m) return null;
    const raw = m[1].replace(",", ".");
    const v = parseFloat(raw);
    if(!isFinite(v) || v <= 0 || v > 48) return null;
    return v;
  }

  function syncCallJornadaFromCategoria(){
    const rama = $("rama")?.value || "";
    if(!isCallRama(rama)) return;
    const cat = $("categoria")?.value || "";
    const h = parseHorasCategoria(cat);
    if(h && $("hs")) $("hs").value = String(h);
    if(h && $("lf_hs")) $("lf_hs").value = String(h);
}

  function getEffectiveJornada(){
    const rama = $("rama")?.value || "";
    const isFinal = !!document.getElementById('tabFinal')?.classList.contains('active');
    const src = isFinal ? $("lf_hs") : $("hs");

    let j = 48;

    // Call Center: jornada deriva de la categoria (siempre 1..48)
    if(isCallRama(rama)){
      const h = parseHorasCategoria($("categoria")?.value || "");
      if(h) j = h;
    }else{
      const fallback = num($("hs")?.value || 48) || 48;
      j = num(src?.value || fallback) || fallback;
    }

    // Clamp: minimo 1 / maximo 48
    j = Math.max(1, Math.min(48, j));

    // Reflejar en ambos inputs (aunque esten ocultos)
    if($("hs")) $("hs").value = String(j);
    if($("lf_hs")) $("lf_hs").value = String(j);

    return j;
  }

  function updateCallCenterUI(){
    try{
      const rama = $('rama')?.value || '';
      const showCall = isCallRama(rama);
      const hsWrap = $('hsWrap');
      if(hsWrap) hsWrap.style.display = showCall ? 'none' : '';
      if($('hs')) $('hs').disabled = !!showCall;

      const lfHsWrap = $('lf_hsWrap');
      if(lfHsWrap) lfHsWrap.style.display = showCall ? 'none' : '';
      if($('lf_hs')) $('lf_hs').disabled = !!showCall;

      if(showCall){ try{ syncCallJornadaFromCategoria(); }catch{} }
    }catch(e){}
  }


function applyBranchUI(){
    const rama = $('rama')?.value || '';
    const showAgua = isAguaRama(rama);
    const showTur = isTurismoRama(rama);
    const showFun = isFunebresRama(rama);
    const showCall = isCallRama(rama);

    // CALL CENTER: ocultar jornada (la trae la categoría) y sincronizar hs
    const hsWrap = $('hsWrap');
    if(hsWrap) hsWrap.style.display = showCall ? 'none' : '';
    if($('hs')) $('hs').disabled = !!showCall;
    if(showCall){ try{ syncCallJornadaFromCategoria(); }catch{} }

    // FÚNEBRES: ocultar agrupamiento y forzar valor "—"
    const agrupWrap = $("agrupWrap");
    const agrupSel = $("agrup");
    if(agrupWrap) agrupWrap.style.display = showFun ? "none" : "";
    if(agrupSel){
      agrupSel.disabled = !!showFun;
      if(showFun) agrupSel.value = "";
    }

    const aguaBlock = $('aguaBlock');
    if(aguaBlock) aguaBlock.style.display = showAgua ? '' : 'none';
    const aguaBlockLf = $('lf_aguaBlock');
    if(aguaBlockLf) aguaBlockLf.style.display = showAgua ? '' : 'none';

    const boxTitulo = $('boxTitulo');
    if(boxTitulo) boxTitulo.style.display = showTur ? '' : 'none';

    const funBlock = $('funBlock');
    if(funBlock) funBlock.style.display = showFun ? '' : 'none';

    // limpiar valores cuando no aplica
    if(!showAgua){
      const a = $('aguaConexCat');
      if(a) a.value = '';
      const af = $('lf_aguaConexCat');
      if(af) af.value = '';
      const q = $('aguaConexiones');
      if(q) q.value = '0';
      const qf = $('lf_aguaConexiones');
      if(qf) qf.value = '0';
      setText('aguaConexInfo', '');
      setText('lf_aguaConexInfo', '');
    }
    else{
      // sincronizar selector y cantidad de conexiones entre Mensual y Final
      const a = $('aguaConexCat');
      const af = $('lf_aguaConexCat');
      if(a && af){
        if(a.value && !af.value) af.value = a.value;
        if(af.value && !a.value) a.value = af.value;
      }
      const q = $('aguaConexiones');
      const qf = $('lf_aguaConexiones');
      if(q && qf){
        if((q.value || '0') !== '0' && (qf.value || '0') === '0') qf.value = q.value;
        if((qf.value || '0') !== '0' && (q.value || '0') === '0') q.value = qf.value;
      }
      try{ updateAguaConexInfo(); }catch{}
    }
    if(!showTur){
      const t = $('turTitulo');
      if(t) t.value = '0';
    }

    if(!showFun){
      clearFunebresAdics();
    }else{
      // cargar para el mes seleccionado
      loadFunebresAdicionales();
    }

    // selector de KM: cambia según rama (Turismo vs resto)
    try{ updateKmUI(); }catch{}

    // En Liquidación Final: abrir automáticamente el panel de extras cuando la rama
    // tiene opciones propias visibles dentro de ese panel (Turismo / Fúnebres / Agua).
    try{
      if(window.__activeTab === 'final'){
        const det = $('lf_extras_details');
        if(det) det.open = !!(showTur || showFun || showAgua);
      }
    }catch{}
  }

  function updateKmUI(){
    const rama = $('rama')?.value || '';
    const sel = $('kmTipo');
    if(!sel) return;

    const isTur = isTurismoRama(rama);
    const prev = sel.value;

    const opts = isTur
      ? [
          {v:'',  t:'--'},
          {v:'C4',t:'Operativo C4'},
          {v:'C5',t:'Operativo C5'},
        ]
      : [
          {v:'',  t:'--'},
          {v:'AY',t:'Ayudante de Chofer'},
          {v:'CH',t:'Chofer'},
        ];

    sel.innerHTML = opts.map(o => `<option value="${escapeHtml(o.v)}">${escapeHtml(o.t)}</option>`).join('');

    // Autoselección (si aplica)
    let want = '';
    const cat = ($('categoria')?.value || '').toUpperCase();
    if(isTur){
      if(cat.includes('C4')) want = 'C4';
      if(cat.includes('C5')) want = 'C5';
    }else{
      if(cat.includes('AYUDANTE')) want = 'AY';
      if(cat.includes('CHOFER')) want = 'CH';
    }

    if(want) sel.value = want;
    else if(opts.some(o => o.v === prev)) sel.value = prev;
    else sel.value = '';
  }

  async function loadMeta(){
    setText("status", "Cargando maestro…");
    META = await fetchJSON(`${API_BASE}/meta`);
    // META esperado: {ramas:{}, meses:{}, ...} o {ramas:[...], meses:[...]}
    const ramas = Array.isArray(META.ramas) ? META.ramas : Object.keys(META.ramas||{}).filter(k => META.ramas[k]);
    const mesesRaw = Array.isArray(META.meses) ? META.meses : Object.keys(META.meses||{}).filter(k => META.meses[k]);
    // normalizar meses válidos AAAA-MM y ordenar
    ALL_MESES = (mesesRaw||[]).filter(m => /^\d{4}-\d{2}$/.test(m)).sort();

    fillSelect($("rama"), ramas, "Rama");

    // defaults
    if(ramas.includes("GENERAL")) $("rama").value = "GENERAL";
    refreshMesesForRama($("rama")?.value || "GENERAL");

    applyBranchUI();
    await updateAguaConexInfo();

    await refreshAgrupCat();
    setText("status", "Listo.");
  }

  function getAgrupsForRama(rama){
    // FÚNEBRES no usa agrupamiento (evita errores por combinaciones inexistentes)
    if(isFunebresRama(rama)) return ["—"];
    const r = (META && META.agrupamientos) ? META.agrupamientos : (META && META.agrups) ? META.agrups : null;
    if(r && r[rama]) return r[rama];
    // fallback: si no viene mapeo, usar GENERAL
    return ["GENERAL"];
  }

  function getCatsFor(rama, agrup){
    const c = (META && META.categorias) ? META.categorias : (META && META.cats) ? META.cats : null;
    if(c && c[rama] && c[rama][agrup]) return c[rama][agrup];
    return [];
  }

  async function refreshAgrupCat(){
    const rama = $("rama")?.value || "";
    if(!META || !rama){ return; }

    // Meses por rama (Etapa 2)
    refreshMesesForRama(rama);

    applyBranchUI();

    const isFun = isFunebresRama(rama);

    const agrups = isFun ? ["—"] : getAgrupsForRama(rama);
    fillSelect($("agrup"), agrups, isFun ? "—" : "Agrupamiento");
    if(isFun) $("agrup").value = "—";
    else if(agrups.includes("GENERAL")) $("agrup").value = "GENERAL";

    const agrup = $("agrup")?.value || "";
    const cats = getCatsFor(rama, agrup);
    fillSelect($("categoria"), cats, "Categoría");
    // seleccionar la primera real si hay
    if(cats.length) $("categoria").value = cats[0];
    try{ syncCallJornadaFromCategoria(); }catch{}

    updateCallCenterUI();

    try{ updateKmUI(); }catch{}

    await refreshPayload();
  }

  async function refreshCatsOnly(){
    const rama = $("rama")?.value || "";
    let agrup = $("agrup")?.value || "";
    if(!META || !rama){ return; }
    if(isFunebresRama(rama)){
      agrup = "—";
      if($("agrup")) $("agrup").value = "—";
    }
    if(!agrup){ return; }
    const cats = getCatsFor(rama, agrup);
    fillSelect($("categoria"), cats, "Categoría");
    if(cats.length) $("categoria").value = cats[0];
    try{ syncCallJornadaFromCategoria(); }catch{}
    updateCallCenterUI();

    try{ updateKmUI(); }catch{}
    await refreshPayload();
  }

  function parseOsecacBool(){
    const raw = ($("osecac")?.value || "").toString().toLowerCase();
    if(raw === "true" || raw === "1") return true;
    if(raw === "false" || raw === "0") return false;
    // tu select usa "si"/"no" o texto "Si (3% NR + $100)"
    return raw.includes("si") || raw.includes("sí");
  }

  function parseAfiliadoBool(){
    const cb = $("afiliado");
    const cbOn = !!(cb && cb.type === "checkbox" && cb.checked);
    const sel = $("afiliado_selector");
    const selRaw = (sel ? (sel.value || "") : "").toString().trim();
    const selUp = selRaw.toUpperCase();
    const fijo = num($("afiliado_fijo")?.value || 0);

    // Se considera afiliado si:
    // - el checkbox está marcado, o
    // - el selector no es "NO", o
    // - hay monto fijo > 0
    return cbOn || (selUp && selUp !== "NO") || fijo > 0;
  }

  function parseSindPct(){
    const sel = $("afiliado_selector");
    if(!sel) return 0;
    const v = (sel.value || "").toString().trim().toUpperCase();
    if(!v || v === "NO") return 0;
    // admite "2", "2.5", "2,5"
    const n = Number(v.replace(",", "."));
    return (Number.isFinite(n) ? n : 0);
  }

  function parseSindFijo(){
    // Monto fijo opcional de afiliación sindical (cuando corresponde)
    return num($("afiliado_fijo")?.value || 0) || 0;
  }

  async function refreshPayload(){
    try{
      const rama = $("rama")?.value || "";
      const mes = $("mes")?.value || "";
      const agrup = $("agrup")?.value || "";
      const categoria = $("categoria")?.value || "";
      if([rama,mes,agrup,categoria].some(v => !v)) return;

      const jornada = getEffectiveJornada();

      const url = new URL(`${API_BASE}/payload`);
      url.searchParams.set("rama", rama);
      url.searchParams.set("mes", mes);
      url.searchParams.set("agrup", agrup);
      url.searchParams.set("categoria", categoria);
      url.searchParams.set("jornada", String(jornada));
      // Agua Potable: conexiones (cantidad y/o categoría)
      const isAgua = (normRama(rama) === "AGUA POTABLE" || normRama(rama) === "AGUA" || normRama(rama) === "AGUAPOTABLE");
      if(isAgua){
        const conex_cat = (document.getElementById("aguaConexCat")?.value || "").trim();
        const conexiones = parseInt(document.getElementById("aguaConexiones")?.value || "0", 10) || 0;
        if(conex_cat && conex_cat !== "--") url.searchParams.set("conex_cat", conex_cat);
        if(conexiones > 0) url.searchParams.set("conexiones", String(conexiones));
      }
const p = await fetchJSON(url.toString());
      if(!p || p.ok === false) throw new Error((p && p.status) ? p.status : "payload error");

      setVal("basico", (p.basico_base ?? p.basico ?? 0));
      setVal("nrVar", (p.no_rem_base ?? p.no_rem ?? 0));
      setVal("nrSF", (p.suma_fija_base ?? p.suma_fija ?? 0));
      const nrTot = num(p.no_rem_base ?? p.no_rem ?? 0) + num(p.suma_fija_base ?? p.suma_fija ?? 0);
      setVal("nrTotal", nrTot);

      // Labels oficiales NR por rama
      if(p.labels){
        if(p.labels.no_rem) setText("lblNrVar", p.labels.no_rem);
        if(p.labels.suma_fija) setText("lblNrSF", p.labels.suma_fija);
      }

      // Encabezado de recibo
      setText("outRama", rama);
      setText("outAgrup", agrup);
      setText("outCat", categoria);
      setText("outEscala", `Escala ${mes}`);

      // Fúnebres: refrescar lista de adicionales al cambiar mes/categoría
      if(isFunebresRama(rama)){
        try{ await loadFunebresAdicionales(); }catch{}
      }

      setText("status", "Listo.");

      // Sugerir MEJOR SALARIO para Liquidación Final (no pisa si es manual)
      try{ if(window.lf_autofill_mejor) await window.lf_autofill_mejor(); }catch(_){ }

    }catch(err){
      console.error(err);
      setText("status", "No se pudo cargar la base.");
    }
  }

  function clearTbody(id){
    const tb = $(id);
    if(!tb) return;
    tb.innerHTML = "";
  }

  function addRowMensual(concepto, base, r, n, d){
    const tb = $("tbodyMensual");
    if(!tb) return;
    const tr = document.createElement("tr");
    const tdC = document.createElement("td"); tdC.textContent = concepto;
    const tdB = document.createElement("td"); tdB.className='right col-base-num'; tdB.textContent = base != null ? money(base) : "";
    const tdR = document.createElement("td"); tdR.className='right'; tdR.textContent = money(r||0);
    const tdN = document.createElement("td"); tdN.className='right'; tdN.textContent = money(n||0);
    const tdD = document.createElement("td"); tdD.className='right'; tdD.textContent = money(d||0);
    tr.append(tdC, tdB, tdR, tdN, tdD);
    tb.appendChild(tr);
  }

  // Arma la URL del cálculo mensual con los valores actuales del formulario.
  // Se usa también para completar el MEJOR SALARIO en Liquidación Final.
  function buildMensualURL(){
    const rama = $("rama")?.value || "";
    const mes = $("mes")?.value || "";
    const agrup = $("agrup")?.value || "";
    const categoria = $("categoria")?.value || "";
    const jornada = getEffectiveJornada();
    const anios_antig = num($("anios")?.value || 0) || 0;

    const fer_no_trab = Math.max(0, parseInt($("ferNoTrab")?.value || "0", 10) || 0);
    const fer_trab    = Math.max(0, parseInt($("ferTrab")?.value || "0", 10) || 0);
    const vac_goz     = Math.max(0, parseInt($("coVacGoz")?.value || "0", 10) || 0);
    const aus_inj     = Math.max(0, parseInt($("coAus")?.value || "0", 10) || 0);
    const jubilado = !!($("coJub")?.checked);
    const susp_dias = Math.max(0, parseInt($("coSusp")?.value || "0", 10) || 0);
    const embargo = Math.max(0, num($("coEmbargo")?.value || 0) || 0);
    const hex50  = Math.max(0, num($("he50")?.value || 0) || 0);
    const hex100 = Math.max(0, num($("he100")?.value || 0) || 0);
    const hs_noct = Math.max(0, num($("hsNoct")?.value || 0) || 0);
    const a_cuenta_rem = Math.max(0, num($("aCuenta")?.value || 0) || 0);
    const viaticos_nr = Math.max(0, num($("viaticosNR")?.value || 0) || 0);
    const manejo_caja = Math.max(0, num($("manejoCaja")?.value || 0) || 0);
    const cajero_tipo = $("cajeroTipo")?.value || "";
    const faltante_caja = Math.max(0, num($("faltanteCaja")?.value || 0) || 0);
    const armado_vidriera = !!($("armadoAuto")?.checked);
    const adelanto_sueldo = Math.max(0, num($("adelantoSueldo")?.value || 0) || 0);
    const sac_prop_mes = !!($("coSacProp")?.checked);

    const osecac = parseOsecacBool();
    const afiliado = parseAfiliadoBool();
    const sind_pct = parseSindPct();
    const sind_fijo = parseSindFijo();
    const titulo_pct = parseTituloPct();
    const zona_pct = parseZonaPct();

    // Chofer/Ayudante
    const km_tipo = $("kmTipo")?.value || "";
    const km_menos100 = Math.max(0, parseInt($("kmMenos100")?.value || "0", 10) || 0);
    const km_mas100 = Math.max(0, parseInt($("kmMas100")?.value || "0", 10) || 0);
    // Agua potable
    const conex_cat = (document.getElementById("aguaConexCat")?.value || "").trim();
    const conexiones = Math.max(0, parseInt(document.getElementById("aguaConexiones")?.value || "0", 10) || 0);
    // Fúnebres
    const fun_adics = getFunebresAdics();

    const url = new URL("/calcular", location.origin);
    url.searchParams.set("rama", rama);
    url.searchParams.set("mes", mes);
    url.searchParams.set("agrup", agrup);
    url.searchParams.set("categoria", categoria);
    url.searchParams.set("jornada", String(jornada));
    url.searchParams.set("anios_antig", String(anios_antig));
    url.searchParams.set("osecac", osecac ? "true" : "false");
    url.searchParams.set("afiliado", afiliado ? "true" : "false");
    url.searchParams.set("sind_pct", String(sind_pct || 0));
    url.searchParams.set("sind_fijo", String(sind_fijo || 0));
    url.searchParams.set("titulo_pct", String(titulo_pct || 0));
    url.searchParams.set("zona_pct", String(zona_pct || 0));
    url.searchParams.set("fer_no_trab", String(fer_no_trab));
    url.searchParams.set("fer_trab", String(fer_trab));
    url.searchParams.set("vac_goz", String(vac_goz));
    url.searchParams.set("aus_inj", String(aus_inj));
    url.searchParams.set("jubilado", jubilado ? "true" : "false");
    url.searchParams.set("susp_dias", String(susp_dias));
    url.searchParams.set("embargo", String(embargo));
    url.searchParams.set("hex50", String(hex50));
    url.searchParams.set("hex100", String(hex100));
    url.searchParams.set("hs_noct", String(hs_noct));
    url.searchParams.set("a_cuenta_rem", String(a_cuenta_rem));
    url.searchParams.set("viaticos_nr", String(viaticos_nr));
    url.searchParams.set("manejo_caja", String(manejo_caja));
    url.searchParams.set("cajero_tipo", cajero_tipo);
    url.searchParams.set("faltante_caja", String(faltante_caja));
    url.searchParams.set("armado_vidriera", armado_vidriera ? "true" : "false");
    url.searchParams.set("adelanto_sueldo", String(adelanto_sueldo));
    if(sac_prop_mes) url.searchParams.set("sac_prop_mes", "true");
    url.searchParams.set("km_tipo", km_tipo);
    url.searchParams.set("km_menos100", String(km_menos100));
    url.searchParams.set("km_mas100", String(km_mas100));
    if(conex_cat && conex_cat !== "--") url.searchParams.set("conex_cat", conex_cat);
    if(conexiones > 0) url.searchParams.set("conexiones", String(conexiones));
    url.searchParams.set("fun_adic", fun_adics.join(","));
    return url;
  }

  async function calcularMensual(){
    try{
      const rama = $("rama")?.value || "";
      const mes = $("mes")?.value || "";
      const agrup = $("agrup")?.value || "";
      const categoria = $("categoria")?.value || "";
      if([rama,mes,agrup,categoria].some(v => !v)){ alert("Elegí Rama/Agrup/Categoría/Mes."); return; }

      const jornada = getEffectiveJornada();
      const anios_antig = num($("anios")?.value || 0) || 0;

      // Feriados / Ausencias
      const fer_no_trab = Math.max(0, parseInt($("ferNoTrab")?.value || "0", 10) || 0);
      const fer_trab    = Math.max(0, parseInt($("ferTrab")?.value || "0", 10) || 0);
      const vac_goz     = Math.max(0, parseInt($("coVacGoz")?.value || "0", 10) || 0);
      const aus_inj     = Math.max(0, parseInt($("coAus")?.value || "0", 10) || 0);
      // Etapa 8: Jubilado / Suspensión (días) / Embargo
      const jubilado = !!($("coJub")?.checked);
      const susp_dias = Math.max(0, parseInt($("coLicSG")?.value || "0", 10) || 0);
      const embargo = Math.max(0, parseMoneyText($("coEmbargo")?.value || ""));
// Horas extras / nocturnas
      const hex50 = num($("hex50")?.value || 0) || 0;
      const hex100 = num($("hex100")?.value || 0) || 0;
      const hs_noct = num($("hsNoct")?.value || 0) || 0;

      // Adicional por KM (Chofer / Ayudante)
      const km_tipo = String($("kmTipo")?.value || "").trim();
      const km_menos100 = Math.max(0, parseInt($("kmMenos100")?.value || "0", 10) || 0);
      const km_mas100 = Math.max(0, parseInt($("kmMas100")?.value || "0", 10) || 0);

      // Etapa 5/6: A cuenta (REM) / Viáticos (NR sin aportes)
      const a_cuenta_rem = Math.max(0, num($("aCuentaNR")?.value || 0) || 0);
      const viaticos_nr = Math.max(0, num($("viaticosNR")?.value || 0) || 0);
      const manejo_caja = !!($('manejoCaja')?.checked);
      const cajero_tipo = ($('cajero_tipo')?.value || '').toString();
      const faltante_caja = Math.max(0, parseMoneyText($('faltanteCajaInput')?.value || ''));
      const armado_vidriera = !!($('armadoAuto')?.checked);
      const adelanto_sueldo = Math.max(0, num($('adelantoSueldo')?.value || 0) || 0);
      const sac_prop_mes = !!($('coSacProp')?.checked);

      const osecac = parseOsecacBool();
      const afiliado = parseAfiliadoBool();
      const zona_pct = num($('zona')?.value || 0) || 0;
      const sind_pct = afiliado ? parseSindPct() : 0;
      const sind_fijo = afiliado ? num($("afiliado_fijo")?.value || 0) : 0;
      const titulo_pct = (normRama(rama) === "TURISMO") ? (num($("turTitulo")?.value || 0) || 0) : 0;
      const conex_cat = (normRama(rama) === "AGUA POTABLE" || normRama(rama) === "AGUA" || normRama(rama) === "AGUAPOTABLE")
        ? String($("aguaConexCat")?.value || "").trim()
        : "";      // Fúnebres: adicionales seleccionados (ids)
      const conexiones = 0;
      const fun_adics = (isFunebresRama(rama))
        ? Array.from(document.querySelectorAll('#funList input[type="checkbox"]:checked'))
            .map(el => (el && el.value != null) ? String(el.value) : "")
            .filter(v => v)
        : [];

      const url = new URL(`${API_BASE}/calcular`);
      url.searchParams.set("rama", rama);
      url.searchParams.set("agrup", agrup);
      url.searchParams.set("categoria", categoria);
      url.searchParams.set("mes", mes);
      url.searchParams.set("jornada", String(jornada));
      // Agua Potable: conexiones (cantidad y/o categoría)
      const isAgua = (normRama(rama) === "AGUA POTABLE" || normRama(rama) === "AGUA" || normRama(rama) === "AGUAPOTABLE");
      if(isAgua){
        const conex_cat = (document.getElementById("aguaConexCat")?.value || "").trim();
        const conexiones = parseInt(document.getElementById("aguaConexiones")?.value || "0", 10) || 0;
        if(conex_cat && conex_cat !== "--") url.searchParams.set("conex_cat", conex_cat);
        if(conexiones > 0) url.searchParams.set("conexiones", String(conexiones));
      }
      url.searchParams.set("anios_antig", String(anios_antig));
      url.searchParams.set("osecac", osecac ? "true" : "false");
      url.searchParams.set("afiliado", afiliado ? "true" : "false");
      url.searchParams.set("sind_pct", String(sind_pct));
      url.searchParams.set("sind_fijo", String(sind_fijo));
      url.searchParams.set("titulo_pct", String(titulo_pct));
      url.searchParams.set("zona_pct", String(zona_pct));
      url.searchParams.set("fer_no_trab", String(fer_no_trab));
      url.searchParams.set("fer_trab", String(fer_trab));
    url.searchParams.set("vac_goz", String(vac_goz));
      url.searchParams.set("aus_inj", String(aus_inj));
      // Etapa 8
      url.searchParams.set("jubilado", jubilado ? "true" : "false");
      url.searchParams.set("susp_dias", String(susp_dias));
      url.searchParams.set("embargo", String(embargo));
      url.searchParams.set("hex50", String(hex50));
      url.searchParams.set("hex100", String(hex100));
      url.searchParams.set("hs_noct", String(hs_noct));
      // Etapa 5/6
      url.searchParams.set("a_cuenta_rem", String(a_cuenta_rem));
      url.searchParams.set("viaticos_nr", String(viaticos_nr));
      // Etapa 7
      url.searchParams.set("manejo_caja", manejo_caja ? "true" : "false");
      if(cajero_tipo) url.searchParams.set("cajero_tipo", cajero_tipo);
      url.searchParams.set("faltante_caja", String(faltante_caja));
      url.searchParams.set("armado_vidriera", armado_vidriera ? "true" : "false");
      url.searchParams.set("adelanto_sueldo", String(adelanto_sueldo));
      if(sac_prop_mes) url.searchParams.set("sac_prop_mes", "true");
      // KM
      if(km_tipo) url.searchParams.set("km_tipo", km_tipo);
      url.searchParams.set("km_menos100", String(km_menos100));
      url.searchParams.set("km_mas100", String(km_mas100));
      for (const id of fun_adics) url.searchParams.append("fun_adic", id);

      const data = await fetchJSON(url.toString());

      // Guardar el último cálculo mensual para reutilizar en Liquidación Final (MEJOR SALARIO)
      window.__lastMensualCalc = data;
      window.__lastMensualKey = [rama, agrup, categoria, mes, jornada, anios_antig, osecac, afiliado, sind_pct, sind_fijo, titulo_pct, zona_pct].join("|");

      // Guardar último mensual para usar en Liquidación Final (MEJOR SALARIO)
      try{
        const rem = num(data?.totales?.rem);
        const nr = num(data?.totales?.nr);
        const key = [rama, agrup, categoria, mes, jornada].join("|");
        window.__lastMensualCalc = {
          key,
          rama,
          agrup,
          categoria,
          mes,
          jornada,
          totales: { rem, nr, total: rem + nr }
        };
        // Si estoy en la pestaña Final, refrescar MEJOR SALARIO automáticamente
        if(document.querySelector('button.tab.active')?.getAttribute('data-tab') === 'final'){
          if($('lf_mrmnh')) $('lf_mrmnh').value = (rem+nr).toFixed(2);
        }
      }catch{ /* ignore */ }
      clearTbody("tbodyMensual");

      // Etapa 9: dedupe visual (evita filas duplicadas por render/bugs)
      const rawItems = Array.isArray(data.items) ? data.items : [];
      const seen = new Set();
      const items = [];
      for(const it of rawItems){
        const concepto = (it && it.concepto != null) ? String(it.concepto).trim() : "";
        const sig = [
          concepto,
          num(it?.base).toFixed(2),
          num(it?.r).toFixed(2),
          num(it?.n).toFixed(2),
          num(it?.d).toFixed(2)
        ].join("|");
        if(seen.has(sig)) continue;
        seen.add(sig);
        items.push(it);
      }
      // Orden: Remunerativos → No Remunerativos → Descuentos
      const remItems = [];
      const nrItems  = [];
      const dedItems = [];
      const otherItems = [];
      for(const it of items){
        const r = num(it?.r);
        const n = num(it?.n);
        const d = num(it?.d);
        if(d > 0 && r <= 0 && n <= 0) dedItems.push(it);
        else if(r > 0) remItems.push(it);
        else if(n > 0) nrItems.push(it);
        else otherItems.push(it);
      }
      [...remItems, ...nrItems, ...dedItems, ...otherItems]
        .forEach(it => addRowMensual(it.concepto, it.base, it.r, it.n, it.d));

      const t = data.totales || {};
      setText("totRem", money(t.rem || 0));
      setText("totNR", money(t.nr || 0));
      setText("totDed", money(t.ded || 0));
      setText("neto", money(t.neto || 0));

      // Encabezado + labels desde API
      setText("outRama", data.rama || rama);
      setText("outAgrup", data.agrup || agrup);
      setText("outCat", data.categoria || categoria);
      setText("outEscala", `Escala ${data.mes || mes}`);
      if(data.labels){
        if(data.labels.no_rem) setText("lblNrVar", data.labels.no_rem);
        if(data.labels.suma_fija) setText("lblNrSF", data.labels.suma_fija);
      }

      setText("status", "Calculado.");
    }catch(err){
      console.error(err);
      alert("Error al calcular (API). Revisá conexión o datos.");
      setText("status", "Error al calcular.");
    }
  }

  // =====================
  // Etapa 3: Impresión / PDF (evita hoja en blanco)
  // =====================
  function escapeHtml(s){
    return (s ?? "").toString()
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/\"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function fmtDateISO(iso){
    if(!iso) return '–';
    const parts = String(iso).split('-');
    if(parts.length !== 3) return String(iso);
    const [y,m,d] = parts;
    if(!y || !m || !d) return String(iso);
    return `${d}/${m}/${y}`;
  }


  function cloneTableForPrint(tab){
    const sel = (tab === 'final') ? '#paneFinal table.table' : '#paneMensual table.table';
    const src = document.querySelector(sel);
    if(!src) return null;
    const tbl = src.cloneNode(true);

    // Mensual: sacar columna Base (2da columna)
    if(tab !== 'final'){
      tbl.querySelectorAll('tr').forEach(tr => {
        const kids = tr.children;
        if(kids && kids.length >= 5){
          // Concepto | Base | Rem | NR | Desc
          kids[1].remove();
        }
      });
      // Ajustar colspans (Neto a cobrar)
      tbl.querySelectorAll('td[colspan]').forEach(td => {
        const cs = parseInt(td.getAttribute('colspan') || '0', 10);
        if(cs > 0) td.setAttribute('colspan', String(Math.max(1, cs - 1)));
      });
    }

    // En print siempre queremos tabla “limpia”
    tbl.classList.remove('table');
    tbl.classList.add('print-table');

    return tbl;
  }

  function buildPrintArea(tab){
    const area = $('printArea');
    if(!area) return;

    const isFinal = (tab === 'final');
    const titulo = isFinal ? 'Liquidación Final' : 'Recibo Mensual';

    // Header: usar los spans ya armados (fallback a selects)
    const rama = (isFinal ? $('lf_outRama')?.textContent : $('outRama')?.textContent) || $('rama')?.value || '—';
    const agrup = (isFinal ? $('lf_outAgrup')?.textContent : $('outAgrup')?.textContent) || $('agrup')?.value || '—';
    const cat  = (isFinal ? $('lf_outCat')?.textContent : $('outCat')?.textContent) || $('categoria')?.value || '—';
    const escala = (!isFinal
      ? ($('outEscala')?.textContent || '')
      : (`Escala ${(($('lf_egreso')?.value || '').slice(0,7)) || ($('mes')?.value || '')}`)
    ).trim();

    const fiFmt = isFinal ? fmtDateISO($('lf_ingreso')?.value || '') : '';
    const feFmt = isFinal ? fmtDateISO($('lf_egreso')?.value || '') : '';
    const fechas = isFinal ? ` · Ingreso: ${escapeHtml(fiFmt)} · Egreso: ${escapeHtml(feFmt)}` : '';

    const tbl = cloneTableForPrint(tab);

    if(!tbl){
      area.innerHTML = `
        <div class="sheet">
          <div class="title">${escapeHtml(titulo)}</div>
          <div class="subheader">Rama: ${escapeHtml(rama)} · Agrup: ${escapeHtml(agrup)} · Cat: ${escapeHtml(cat)}${fechas} · ${escapeHtml(escala)}</div>
          <div style="margin-top:10mm">No hay datos para imprimir. Primero presioná “Calcular”.</div>
        </div>`;
      return;
    }

    // Armado final
    area.innerHTML = `
      <div class="sheet">
        <div class="title">${escapeHtml(titulo)}</div>
        <div class="subheader">Rama: ${escapeHtml(rama)} · Agrup: ${escapeHtml(agrup)} · Cat: ${escapeHtml(cat)}${fechas} · ${escapeHtml(escala)}</div>
        ${tbl.outerHTML}
      </div>`;
  }

  function imprimirPDF(tab){
    // Construye el printArea ANTES de imprimir.
    try{
      const t = tab || 'mensual';
      buildPrintArea(t);

      // Forzar reflow para que el navegador “vea” el contenido
      const area = $('printArea');
      if(area) void area.offsetHeight;

      
// Ajuste automático de impresión:
// - Si entra en A4 con márgenes: A4 normal
// - Si sobra poquito: A4 + zoom (reduce apenas)
// - Si no entra: Oficio/Legal
// - Si aun así no entra: Legal + zoom
try{
  const iso = document.getElementById('printIsolation');
  const area = $('printArea');
  if(iso && !window.__coPrintStyleOriginal) window.__coPrintStyleOriginal = iso.textContent || '';

  if(iso && area){
    // Mostrar fuera de pantalla para poder medir (display:none => altura 0)
    const prev = {display: area.style.display, position: area.style.position, left: area.style.left, top: area.style.top, visibility: area.style.visibility};
    area.style.display = 'block';
    area.style.position = 'fixed';
    area.style.left = '-10000px';
    area.style.top = '0';
    area.style.visibility = 'hidden';

    // Forzar layout
    void area.offsetHeight;

    const sheet = document.querySelector('#printArea .sheet');
    if(sheet){
      // px por mm (respeta zoom del navegador)
      const probe = document.createElement('div');
      probe.style.width = '100mm';
      probe.style.height = '0';
      probe.style.position = 'absolute';
      probe.style.visibility = 'hidden';
      area.appendChild(probe);
      const pxPerMm = (probe.getBoundingClientRect().width || 377.95) / 100;
      probe.remove();

      const pxH = Math.ceil(sheet.scrollHeight || sheet.getBoundingClientRect().height || 0);
      const contentMm = pxH / pxPerMm;

      const marginMm = 8;
      const A4 = { w: 210.0, h: 297.0 };
      const LEGAL = { w: 215.9, h: 355.6 }; // Oficio / Legal

      const availA4 = A4.h - marginMm*2;
      const availLegal = LEGAL.h - marginMm*2;

      let page = A4;
      let scale = 1;

      // Compacta si hay muchas filas (reduce padding/fuente)
      const needsCompact = contentMm > availA4;
      sheet.classList.toggle('compact', needsCompact);

      // Re-medir con modo compact (puede bajar altura)
      void sheet.offsetHeight;
      const pxH2 = Math.ceil(sheet.scrollHeight || sheet.getBoundingClientRect().height || 0);
      const contentMm2 = pxH2 / pxPerMm;

      if(contentMm2 <= availA4){
        page = A4;
        scale = 1;
      }else if(contentMm2 <= availA4 * 1.06){
        // sobra poquito: A4 + zoom
        page = A4;
        scale = Math.min(1, availA4 / contentMm2);
      }else if(contentMm2 <= availLegal){
        page = LEGAL;
        scale = 1;
      }else{
        page = LEGAL;
        scale = Math.min(1, availLegal / contentMm2);
      }

      // Evitar que quede ilegible
      if(scale < 0.78) scale = 0.78;

      const baseCss = window.__coPrintStyleOriginal || (iso.textContent || '');
      // quitar cualquier @page previo (solo el primero)
      const rest = baseCss.replace(/@page\{[^}]*\}\s*/,'');
      iso.textContent =
        `@page{size:${page.w}mm ${page.h}mm;margin:${marginMm}mm}\n` +
        `@media print{#printArea .sheet{zoom:${scale};}}\n` +
        rest;
    }

    // Restaurar visibilidad en pantalla (se imprime igual por @media print)
    area.style.display = prev.display;
    area.style.position = prev.position;
    area.style.left = prev.left;
    area.style.top = prev.top;
    area.style.visibility = prev.visibility;
  }
}catch(_){ }
// Nombre sugerido al “Guardar como PDF” (Chrome usa document.title)
      __coTitleBeforePrint = document.title;
      document.title = buildPrintFilename(t);

      // Dejar un tick para que pinte antes de abrir el diálogo
      setTimeout(() => window.print(), 60);
    }catch(err){
      console.error(err);
      alert('No se pudo preparar la impresión. Revisá consola.');
    }
  }

  // Limpiar al terminar de imprimir (evita que quede contenido oculto)
  window.addEventListener('afterprint', () => {
    const area = $('printArea');
    if(area) area.innerHTML = '';
    try{
      const iso = document.getElementById('printIsolation');
      if(iso && window.__coPrintStyleOriginal) iso.textContent = window.__coPrintStyleOriginal;
    }catch(_){ }
    if(__coTitleBeforePrint != null){
      document.title = __coTitleBeforePrint;
      __coTitleBeforePrint = null;
    }
  });

  window.imprimirPDF = imprimirPDF;

  // Exponer para botones existentes
  window.calcularMensual = calcularMensual;

  
function wire(){
    // Rama: refrescar agrups/cats y togglear UI condicional.
    $("rama")?.addEventListener("change", async () => {
      try{ applyBranchUI(); }catch(_){ }
      await refreshAgrupCat();
    });

    $("agrup")?.addEventListener("change", async () => {
      await refreshCatsOnly();
    });

    $("categoria")?.addEventListener("change", async () => {
      updateCallCenterUI();
      try{ updateKmUI(); }catch(_){ }
      await refreshPayload();
    });

    $("mes")?.addEventListener("change", refreshPayload);
    $("hs")?.addEventListener("change", refreshPayload);

    // Agua: conexiones (sincroniza Mensual ↔ Final)
    const _syncAguaConex = (fromId, toId) => {
      try{
        const a = $(fromId);
        const b = $(toId);
        if(a && b) b.value = a.value;
      }catch(_){ }
    };
    const _setAguaConexQty = (val) => {
      try{
        if($("aguaConexiones")) $("aguaConexiones").value = String(val);
        if($("lf_aguaConexiones")) $("lf_aguaConexiones").value = String(val);
      }catch(_){ }
    };
    const _afterAguaConexChange = () => {
      try{ updateAguaConexInfo && updateAguaConexInfo(); }catch(_){ }
      refreshPayload();
      try{ window.lf_autofill_mejor && window.lf_autofill_mejor(); }catch(_){ }
    };
    $("aguaConexCat")?.addEventListener("change", () => {
      _setAguaConexQty(0);
      _syncAguaConex("aguaConexCat", "lf_aguaConexCat");
      _afterAguaConexChange();
    });
    $("lf_aguaConexCat")?.addEventListener("change", () => {
      _setAguaConexQty(0);
      _syncAguaConex("lf_aguaConexCat", "aguaConexCat");
      _afterAguaConexChange();
    });
    $("aguaConexiones")?.addEventListener("input", () => {
      _syncAguaConex("aguaConexiones", "lf_aguaConexiones");
      _afterAguaConexChange();
    });
    $("lf_aguaConexiones")?.addEventListener("input", () => {
      _syncAguaConex("lf_aguaConexiones", "aguaConexiones");
      _afterAguaConexChange();
    });

    // Manejo de caja
    $("manejoCaja")?.addEventListener('change', toggleManejoCajaUI);
    toggleManejoCajaUI();

    // Liquidación final: autocompletar años/vacaciones/días y sugerir MEJOR SALARIO
    ['lf_ingreso','lf_egreso','lf_hs','lf_tipo','lf_preaviso','lf_integracion','lf_use_lastday','lf_vac_anuales','lf_vac_no_goz'].forEach(id => {
      $(id)?.addEventListener('change', () => {
        if(id === 'lf_hs'){
          try{
            const lfhs = $('lf_hs');
            if(lfhs) lfhs.dataset.manual = '1';
            if($('hs') && lfhs?.value) $('hs').value = String(lfhs.value);
          }catch(_){ }
        }
        _lfUpdateDerived();
        try{ window.lf_autofill_mejor && window.lf_autofill_mejor(); }catch(_){ }
      });
    });

    // MEJOR SALARIO: si el usuario edita, no pisar más automáticamente
    const mrm = $('lf_mrmnh');
    if(mrm){
      mrm.addEventListener('input', () => {
        const v = (mrm.value || '').trim();
        if(v){
          mrm.dataset.manual = '1';
          setText('diagFinal', 'MEJOR SALARIO editado manualmente.');
        }else{
          delete mrm.dataset.manual;
          try{ window.lf_autofill_mejor && window.lf_autofill_mejor({force:true}); }catch(_){ }
        }
      });
    }

    // Vacaciones no gozadas (LF): si el usuario edita, no autocompletar más
    const vacNG = $('lf_vac_no_goz');
    if(vacNG){
      vacNG.addEventListener('input', () => {
        const v = (vacNG.value || '').toString().trim();
        if(v && Number(v) > 0){
          vacNG.dataset.manual = '1';
        }else{
          delete vacNG.dataset.manual;
          try{ _lfUpdateDerived(); }catch(_){ }
        }
      });
    }

    // Toggle Base (mensual)

    const paneM = $('paneMensual');
    const tBaseM = $('toggleBaseMensual');
    if(paneM) paneM.classList.add('hide-base-col');
    if(tBaseM){
      tBaseM.checked = false;
      tBaseM.addEventListener('change', () => {
        paneM?.classList.toggle('hide-base-col', !tBaseM.checked);
      });
    }

    // Toggle Base (final)
    const paneF = $('paneFinal');
    const tBaseF = $('toggleBaseFinal');
    if(paneF) paneF.classList.add('hide-base-final');
    if(tBaseF){
      tBaseF.checked = false;
      tBaseF.addEventListener('change', () => {
        paneF?.classList.toggle('hide-base-final', !tBaseF.checked);
      });
    }

    _lfUpdateDerived();
  }


  // =====================
  // Etapa 9: Tabs + Liquidación Final
  // =====================
  function ensureExtrasAnchors(){
  if(window.__extrasAnchorsReady) return;
  const root = $("mensualExtrasRoot");
  const hostM = $("mensualExtrasHost");
  const hostF = $("lfExtrasHost");
  if(root && hostM && !window.__extrasAnchorM){
    const aM = document.createComment("CO_EXTRAS_MENSUAL");
    hostM.insertBefore(aM, root);
    window.__extrasAnchorM = aM;
  }
  if(hostF && !window.__extrasAnchorF){
    const aF = document.createComment("CO_EXTRAS_FINAL");
    hostF.appendChild(aF);
    window.__extrasAnchorF = aF;
  }
  window.__extrasAnchorsReady = true;
}

function mountExtrasForTab(tab){
  ensureExtrasAnchors();
  const root = $("mensualExtrasRoot");
  const hostM = $("mensualExtrasHost");
  const hostF = $("lfExtrasHost");
  const aM = window.__extrasAnchorM;
  const aF = window.__extrasAnchorF;

  if(root && hostM && hostF && aM && aF){
    if(tab==="final"){
      hostF.insertBefore(root, aF.nextSibling);
    }else{
      hostM.insertBefore(root, aM.nextSibling);
    }
  }else if(root && hostM && hostF){
    (tab==="final" ? hostF : hostM).appendChild(root);
  }

  const autoWrap = $("autoAntigWrap");
  if(autoWrap) autoWrap.style.display = "none";
}

function switchTab(tab){
    window.__activeTab = tab;
    const tMens = document.getElementById('tabMensual');
    const tFinal = document.getElementById('tabFinal');
    const pMens = document.getElementById('paneMensual');
    const pFinal = document.getElementById('paneFinal');
    if(!tMens || !tFinal || !pMens || !pFinal) return;

    try{ mountExtrasForTab(tab); }catch(_){ }
    try{ applyBranchUI(); }catch(_){ }


    if(tab === 'final'){
      tFinal.classList.add('active');
      tMens.classList.remove('active');
      pFinal.style.display = '';
      pMens.style.display = 'none';
      try{
        const hs = $('hs');
        const lfhs = $('lf_hs');
        if(lfhs && hs && !lfhs.dataset.manual) lfhs.value = String(hs.value || 48);
      }catch(_){ }

      try{ window.lf_autofill_mejor && window.lf_autofill_mejor(); }catch(_){ }
    }else{
      tMens.classList.add('active');
      tFinal.classList.remove('active');
      try{
        const hs = $('hs');
        const lfhs = $('lf_hs');
        if(hs && lfhs && lfhs.value) hs.value = String(lfhs.value);
      }catch(_){ }
      pMens.style.display = '';
      pFinal.style.display = 'none';
    }

    // UX: asegurar reinserción de extras y volver arriba al cambiar de pestaña
    try{ mountExtrasForTab(tab); }catch(_){ }
    try{ requestAnimationFrame(() => { try{ window.scrollTo({top:0,left:0,behavior:'auto'}); }catch(__){ try{ window.scrollTo(0,0); }catch(___){} } }); }catch(_){ try{ window.scrollTo(0,0); }catch(__){} }
  }
  window.switchTab = switchTab;

  function _lfYearsComplete(fi, fe){
    try{
      const a = parseYMDLocal(fi);
      const b = parseYMDLocal(fe);
      if(Number.isNaN(a.getTime()) || Number.isNaN(b.getTime())) return 0;
      let y = b.getFullYear() - a.getFullYear();
      const m = b.getMonth() - a.getMonth();
      if(m < 0 || (m === 0 && b.getDate() < a.getDate())) y -= 1;
      return Math.max(0, y);
    }catch(_){
      return 0;
    }
  }

  function _lfDefaultVacAnuales(anios){
    if(anios < 5) return 14;
    if(anios < 10) return 21;
    if(anios < 20) return 28;
    return 35;
  }

  function _lfUpdateDerived(){
    const fi = $('lf_ingreso')?.value || '';
    const fe = $('lf_egreso')?.value || '';
    const y = _lfYearsComplete(fi, fe);
    if($('lf_anios')) $('lf_anios').value = String(y);
    if($('lf_vac_anuales')) $('lf_vac_anuales').value = String(_lfDefaultVacAnuales(y));
    // Vacaciones no gozadas sugeridas (editable)
    try{
      const vng = $('lf_vac_no_goz');
      if(vng && !vng.dataset.manual){
        const vacAn = parseFloat($('lf_vac_anuales')?.value || '0') || _lfDefaultVacAnuales(y);
        const dfi = parseYMDLocal(fi);
        const dfe = parseYMDLocal(fe);
        if(!Number.isNaN(dfi.getTime()) && !Number.isNaN(dfe.getTime())){
          const startYear = new Date(dfe.getFullYear(), 0, 1);
          const start = (dfi > startYear) ? dfi : startYear;
          const msDay = 24*60*60*1000;
          const diasAnio = Math.max(0, Math.floor((dfe - start) / msDay) + 1);
          const sug = diasAnio ? (vacAn * (diasAnio/365.0)) : 0;
          const cur = parseFloat(vng.value || '0') || 0;
          if(cur <= 0){
            vng.value = Number.isFinite(sug) ? sug.toFixed(2) : '0';
          }
        }
      }
    }catch(_){ }
    // Días trabajados del mes: automático (1 al día de egreso)
    // IMPORTANTE: evitar corrimientos por timezone (no usar new Date('YYYY-MM-DD')).
    try{
      const el = $('lf_dias_mes');
      if(el){
        let dd = 0;
        const feStr = (fe || '').toString();
        if(feStr.length >= 10 && /^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(feStr.slice(0,10))){
          dd = parseInt(feStr.slice(8,10), 10) || 0;
        }else{
          const d = parseYMDLocal(feStr);
          dd = (!Number.isNaN(d.getTime())) ? d.getDate() : 0;
        }
        el.value = String(dd || 0);
      }
    }catch(_){/* ignore */}
// Mostrar/ocultar bloque indemnizaciones
    const tipo = $('lf_tipo')?.value || 'RENUNCIA';
    const showInd = (tipo === 'DESPIDO_SC');
    document.querySelectorAll('.lf-only-despido').forEach(el => {
      el.style.display = showInd ? '' : 'none';
    });
  }

  function _antigPctPorRama(rama, anios){
    const r = normRama(rama);
    if(r.startsWith('AGUA')){
      // 2% anual acumulativo
      return Math.pow(1.02, Math.max(0, anios)) - 1;
    }
    // resto: 1% por año (no acumulativo)
    return 0.01 * Math.max(0, anios);
  }

  // MEJOR SALARIO (Liquidación Final)
  // Se sugiere con: Básico + NR (var+SF) + Antigüedad + Presentismo,
  // tomando categoría + mes de la baja (YYYY-MM) + jornada.
  async function _lfFetchMejorFromAPI(){
    const rama = $('rama')?.value || '';
    const agrup = $('agrup')?.value || '';
    const categoria = $('categoria')?.value || '';
    const jornada = getEffectiveJornada();

    let fe = $('lf_egreso')?.value || '';
    if(!fe && $('lf_use_lastday')?.checked){
      const msel = $('mes')?.value || '';
      const last = _lastDayOfYYYYMM(msel);
      if(last){
        fe = last;
        if($('lf_egreso')) $('lf_egreso').value = fe;
        _lfUpdateDerived();
      }
    }
    if(!rama || !agrup || !categoria || !fe) return null;

    const fi = $('lf_ingreso')?.value || '';
    const anios = _lfYearsComplete(fi, fe);
    const mes_baja = fe.slice(0, 7); // YYYY-MM

    const url = new URL('/calcular', API_BASE);
    url.searchParams.set('rama', rama);
    url.searchParams.set('mes', mes_baja);
    url.searchParams.set('agrup', agrup);
    url.searchParams.set('categoria', categoria);
    url.searchParams.set('jornada', String(jornada));
    url.searchParams.set('anios_antig', String(anios || 0));

    // sin extras: solo base + antig + presentismo
    url.searchParams.set('osecac', parseOsecacBool() ? 'true' : 'false');
    url.searchParams.set('afiliado', 'false');
    url.searchParams.set('sind_pct', '0');
    url.searchParams.set('sind_fijo', '0');
    url.searchParams.set('titulo_pct', '0');
    url.searchParams.set('zona_pct', '0');
    url.searchParams.set('fer_no_trab', '0');
    url.searchParams.set('fer_trab', '0');
    url.searchParams.set('aus_inj', '0');
    url.searchParams.set('jubilado', 'false');
    url.searchParams.set('susp_dias', '0');
    url.searchParams.set('embargo', '0');
    url.searchParams.set('hex50', '0');
    url.searchParams.set('hex100', '0');
    url.searchParams.set('hs_noct', '0');
    url.searchParams.set('a_cuenta_rem', '0');
    url.searchParams.set('viaticos_nr', '0');
    url.searchParams.set('adelanto_sueldo', '0');
    url.searchParams.set('manejo_caja', 'false');
    url.searchParams.set('cajero_tipo', '');
    url.searchParams.set('faltante_caja', '0');
    url.searchParams.set('armado_vidriera', 'false');
    url.searchParams.set('km_tipo', '');
    url.searchParams.set('km_menos100', '0');
    url.searchParams.set('km_mas100', '0');

    // Agua Potable: conexiones (cantidad y/o categoría)
    try{
      const r = normRama(rama);
      if(r.startsWith('AGUA')){
        const conex = (document.getElementById('lf_aguaConexCat')?.value || document.getElementById('aguaConexCat')?.value || '').trim();
        const qty = parseInt((document.getElementById('lf_aguaConexiones')?.value || document.getElementById('aguaConexiones')?.value || '0'), 10) || 0;
        if(conex && conex !== '--') url.searchParams.set('conex_cat', conex);
        if(qty > 0) url.searchParams.set('conexiones', String(qty));
      }
    }catch(_){/* ignore */}

    const data = await fetchJSON(url.toString());
    if(!data || data.ok === false) return null;

    const bas = num(data.basico || 0);
    const nrBase = (num(data.no_rem || 0) || 0) + (num(data.suma_fija || 0) || 0);

    const items = Array.isArray(data.items) ? data.items : [];
    const find = (name, field) => {
      const key = (name || '').toString().toLowerCase();
      for(const it of items){
        const c = ((it.concepto || '') + '').toLowerCase();
        if(c === key) return num(it[field] || 0) || 0;
      }
      return 0;
    };

    const antigRem = find('Antigüedad', 'r');
    const presRem  = find('Presentismo', 'r');
    const antigNr  = find('Antigüedad (NR)', 'n');
    const presNr   = find('Presentismo (NR)', 'n');

    const mejorRem = bas + antigRem + presRem;
    const mejorNr  = nrBase + antigNr + presNr;
    const total    = mejorRem + mejorNr;

    return { total, mejorRem, mejorNr, mes: mes_baja, jornada };
  }

  // Fallback (si falla la API): aproximación con bases cargadas
  function _lfCalcMejorFallback(){
    const rama = $('rama')?.value || '';
    const anios = num($('lf_anios')?.value || 0) || 0;

    const baseRem = num($('basico')?.value || 0) || 0;
    const baseNr = (num($('nrVar')?.value || 0) || 0) + (num($('nrSF')?.value || 0) || 0);

    const pct = _antigPctPorRama(rama, anios);

    const antigRem = baseRem * pct;
    const antigNr = baseNr * pct;

    const presRem = (baseRem + antigRem) / 12;
    const presNr = (baseNr + antigNr) / 12;

    const mejorRem = baseRem + antigRem + presRem;
    const mejorNr = baseNr + antigNr + presNr;
    const total = mejorRem + mejorNr;

    return { total, mejorRem, mejorNr };
  }

  window.lf_autofill_mejor = async function({force=false}={}){
    const inp = $('lf_mrmnh');
    if(!inp) return;
    if(inp.dataset.manual && !force) return;

    const rama = $('rama')?.value || '';
    const agrup = $('agrup')?.value || '';
    const categoria = $('categoria')?.value || '';
    const jornada = getEffectiveJornada();
    const fe = $('lf_egreso')?.value || '';
    const mes_baja = fe ? fe.slice(0,7) : '';
    const key = [rama, agrup, categoria, mes_baja, jornada, $('lf_ingreso')?.value || '', fe, (document.getElementById('lf_aguaConexCat')?.value || document.getElementById('aguaConexCat')?.value || ''), (document.getElementById('lf_aguaConexiones')?.value || document.getElementById('aguaConexiones')?.value || '0') ].join('|');

    if(window.__lf_mejor_key === key && !force) return;
    window.__lf_mejor_key = key;

    let s = null;
    try{
      s = await _lfFetchMejorFromAPI();
    }catch(err){
      console.warn('lf_autofill_mejor api error', err);
      s = null;
    }

    if(!s || !Number.isFinite(s.total) || s.total <= 0){
      try{ s = _lfCalcMejorFallback(); }catch(_){ s = null; }
    }

    if(!s || !Number.isFinite(s.total) || s.total <= 0){
      inp.value = '0.00';
      window.__lf_mejor = null;
      window.__lf_mejor_ratio = null;
      return;
    }

    inp.value = s.total.toFixed(2);
    window.__lf_mejor = { rem: s.mejorRem, nr: s.mejorNr, total: s.total };
    window.__lf_mejor_ratio = { rem: (s.mejorRem / s.total), nr: (s.mejorNr / s.total) };
    const mesTxt = s.mes || mes_baja || '—';
    setText('diagFinal', `MEJOR SALARIO sugerido (Mes baja ${mesTxt} · Jornada ${jornada}hs) — editable.`);
  };

  function _mapTipoFinal(ui){
    const v = (ui || '').toString().trim().toUpperCase();
    if(v === 'DESPIDO_SC') return 'DESPIDO_SIN_CAUSA';
    if(v === 'DESPIDO_CC') return 'DESPIDO_CON_CAUSA';
    if(v === 'RENUNCIA') return 'RENUNCIA';
    if(v === 'FALLECIMIENTO') return 'FALLECIMIENTO';
    return ui;
  }

  function _lastDayOfYYYYMM(yyyymm){
    try{
      if(!/^\d{4}-\d{2}$/.test(yyyymm||'')) return '';
      const y = parseInt(yyyymm.slice(0,4),10);
      const m = parseInt(yyyymm.slice(5,7),10);
      const d = new Date(y, m, 0); // day 0 of next month = last day of current
      const mm = String(m).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${mm}-${dd}`;
    }catch(_){ return ''; }
  }

  window.calcularFinal = async function(){
    try{
      const rama = $('rama')?.value || '';
      const agrup = $('agrup')?.value || '';
      const categoria = $('categoria')?.value || '';
      if(!rama || !agrup || !categoria){
        alert('Elegí Rama/Agrup/Categoría.');
        return;
      }

      let fi = $('lf_ingreso')?.value || '';
      let fe = $('lf_egreso')?.value || '';
      if(!fe && $('lf_use_lastday')?.checked){
        fe = _lastDayOfYYYYMM($('mes')?.value || '');
        if($('lf_egreso')) $('lf_egreso').value = fe;
        try{ _lfUpdateDerived(); }catch(_){ }
      }

      if(!fi || !fe){
        alert('Completá Fecha de Alta (Ingreso) y Fecha de Baja (Egreso).');
        return;
      }

      const tipo = _mapTipoFinal($('lf_tipo')?.value || 'RENUNCIA');

      const jornada = getEffectiveJornada();

      const mejor_total = parseMoneyInput($('lf_mrmnh')?.value || '0');

      // desglosar MEJOR SALARIO (REM/NR) usando ratio sugerido
      let shareRem = 1.0;
      let shareNr = 0.0;
      if(window.__lf_mejor_ratio && Number.isFinite(window.__lf_mejor_ratio.rem)){
        shareRem = window.__lf_mejor_ratio.rem;
        shareNr = window.__lf_mejor_ratio.nr;
      }else{
        try{
          const s = _lfCalcMejorFallback();
          if(s && s.total > 0){
            shareRem = s.mejorRem / s.total;
            shareNr = s.mejorNr / s.total;
          }
        }catch(_){/* ignore */}
      }
      const mejor_rem = mejor_total * shareRem;
      const mejor_nr = mejor_total * shareNr;
      const dias_mes = (()=>{
        try{
          const feStr = (fe || '').toString();
          if(feStr.length >= 10 && /^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(feStr.slice(0,10))){
            return parseInt(feStr.slice(8,10), 10) || 0;
          }
          const d = parseYMDLocal(feStr);
          if(!Number.isNaN(d.getTime())) return d.getDate();
        }catch(_){ }
        return parseInt(($('lf_dias_mes')?.value || '0'), 10) || 0;
      })();
      const vac_anuales = parseInt(($('lf_vac_anuales')?.value || '14'), 10) || 14;
      const vac_no_gozadas_dias = Math.max(0, parseFloat(($('lf_vac_no_goz')?.value || '0')) || 0);
      const preaviso_dias = parseInt(($('lf_preaviso')?.value || '0'), 10) || 0;
      const integracion = !!$('lf_integracion')?.checked;
      const sac_preaviso = !!$('lf_sac_pre')?.checked;
      const sac_integracion = !!$('lf_sac_int')?.checked;

      const osecac = parseOsecacBool();
      const afiliado = parseAfiliadoBool();
      const jubilado = !!($('coJub')?.checked);
      const sind_pct = afiliado ? parseSindPct() : 0;
      const sind_fijo = afiliado ? parseSindFijo() : 0;
      const embargo = Math.max(0, parseMoneyText($('coEmbargo')?.value || ''));

      // === Extras del mes de baja (mismos controles que Mensual) ===
      const zona_pct = num($('zona')?.value || 0) || 0;
      const titulo_pct = (normRama(rama) === "TURISMO") ? (num($("turTitulo")?.value || 0) || 0) : 0;

      const fer_no_trab = Math.max(0, parseInt($("ferNoTrab")?.value || "0", 10) || 0);
      const fer_trab    = Math.max(0, parseInt($("ferTrab")?.value || "0", 10) || 0);
        const vac_goz     = Math.max(0, parseInt($("coVacGoz")?.value || "0", 10) || 0);
      const aus_inj     = Math.max(0, parseInt($("coAus")?.value || "0", 10) || 0);
      const susp_dias   = Math.max(0, parseInt($("coLicSG")?.value || "0", 10) || 0);

      const hex50   = num($("hex50")?.value || 0) || 0;
      const hex100  = num($("hex100")?.value || 0) || 0;
      const hs_noct = num($("hsNoct")?.value || 0) || 0;

      const km_tipo = String($("kmTipo")?.value || "").trim();
      const km_menos100 = Math.max(0, parseInt($("kmMenos100")?.value || "0", 10) || 0);
      const km_mas100   = Math.max(0, parseInt($("kmMas100")?.value || "0", 10) || 0);

      const a_cuenta_rem = Math.max(0, num($("aCuentaNR")?.value || 0) || 0);
      const viaticos_nr  = Math.max(0, num($("viaticosNR")?.value || 0) || 0);

      const manejo_caja = !!($("manejoCaja")?.checked);
      const cajero_tipo = ($("cajero_tipo")?.value || "").toString();
      const faltante_caja = Math.max(0, parseMoneyText($("faltanteCajaInput")?.value || ""));

      const armado_vidriera = !!($("armadoAuto")?.checked);
      const adelanto_sueldo = Math.max(0, num($("adelantoSueldo")?.value || 0) || 0);

      const fun_adics = (isFunebresRama(rama))
        ? Array.from(document.querySelectorAll('#funList input[type="checkbox"]:checked'))
            .map(el => (el && el.value != null) ? String(el.value) : "")
            .filter(v => v)
        : [];

      const qs = new URLSearchParams({
        rama, agrup, categoria,
        jornada: String(jornada || 48),
        fecha_ingreso: fi,
        fecha_egreso: fe,
        tipo,
        mejor_rem: String(mejor_rem),
        mejor_nr: String(mejor_nr),
        mejor_total: String(mejor_total),
        dias_mes: String(dias_mes),
        vac_anuales: String(vac_anuales),
        vac_no_gozadas_dias: String(vac_no_gozadas_dias),
        preaviso_dias: String(preaviso_dias),
        integracion: String(integracion),
        sac_preaviso: String(sac_preaviso),
        sac_integracion: String(sac_integracion),
        osecac: osecac ? 'true' : 'false',
        afiliado: afiliado ? 'true' : 'false',
        sind_pct: String(sind_pct || 0),
        sind_fijo: String(sind_fijo || 0),
        titulo_pct: String(titulo_pct || 0),
        zona_pct: String(zona_pct || 0),
        fer_no_trab: String(fer_no_trab),
        fer_trab: String(fer_trab),
          vac_goz: String(vac_goz),
        aus_inj: String(aus_inj),
        susp_dias: String(susp_dias),
        hex50: String(hex50),
        hex100: String(hex100),
        hs_noct: String(hs_noct),
        a_cuenta_rem: String(a_cuenta_rem),
        viaticos_nr: String(viaticos_nr),
        manejo_caja: manejo_caja ? 'true' : 'false',
        cajero_tipo: cajero_tipo,
        faltante_caja: String(faltante_caja),
        armado_vidriera: armado_vidriera ? 'true' : 'false',
        adelanto_sueldo: String(adelanto_sueldo),
        km_tipo: km_tipo,
        km_menos100: String(km_menos100),
        km_mas100: String(km_mas100),
        jubilado: jubilado ? 'true' : 'false',
        embargo: String(embargo || 0),
      });

      // Fúnebres: múltiples adicionales
      try{
        for(const id of fun_adics){
          if(id) qs.append('fun_adic', id);
        }
      }catch(_){ }

      // Fúnebres: múltiples ids
      try{
        for(const id of fun_adics){
          if(id) qs.append('fun_adic', id);
        }
      }catch(_){ }

      setText('diagFinal', 'Calculando...');
      const url = new URL('/calcular-final', API_BASE);
      url.search = qs.toString();
      const data = await fetchJSON(url.toString());

      
      // Render tabla (LF): ordenar por tipo y unificar columna NR/Indemnizatorio
      const tbody = document.getElementById('tbodyFinal');
      if(tbody) tbody.innerHTML = '';

      const baseNum = (v) => {
        const n = Number(v);
        return Number.isFinite(n) ? n.toFixed(2) : '';
      };

      const raw = (data.items || []).map((it, idx) => ({
        concepto: String(it?.concepto || '').trim() || '—',
        base: (it?.base!=null && it.base!=='') ? String(it.base) : '',
        r: Number(it?.r || 0) || 0,
        n: Number(it?.n || 0) || 0,
        i: Number(it?.i || 0) || 0,
        d: Number(it?.d || 0) || 0,
        seq: idx
      }));

      // 1) Unificar Integración mes despido en 2 filas (Rem / NR)
      const reInt = /Integración mes despido\s*\((\d+)\s*d[ií]as?\)/i;
      let intDays = null;
      let intSeq = null;
      let intRem = 0, intNR = 0;
      const rawKeep = [];
      for(const it of raw){
        const c = it.concepto;
        if(c.includes('Integración mes despido') || c.includes('(Integración mes despido')){
          const m = c.match(reInt);
          if(m && intDays==null) intDays = Number(m[1]);
          if(intSeq==null) intSeq = it.seq;
          intRem += it.r;
          intNR  += it.n;
          continue;
        }
        rawKeep.push(it);
      }
      const merged = [...rawKeep];
      if(intDays && (Math.abs(intRem)>1e-6 || Math.abs(intNR)>1e-6)){
        const baseRem = intDays ? (intRem * 30 / intDays) : 0;
        const baseNR  = intDays ? (intNR  * 30 / intDays) : 0;
        const s = (intSeq!=null) ? intSeq : -1;
        merged.push({ concepto:`Integración mes despido (${intDays} días) — Remunerativo`, base: baseNum(baseRem), r:intRem, n:0, i:0, d:0, seq:s + 0.01 });
        merged.push({ concepto:`Integración mes despido (${intDays} días) — No Remunerativo`, base: baseNum(baseNR), r:0, n:intNR, i:0, d:0, seq:s + 0.02 });
      }

      // 2) Desglosar filas mixtas (si existieran) y clasificar para ordenar
      const rows = [];
      const pushRow = (concepto, base, r, n, i, d, kind, seq) => {
        rows.push({ concepto, base: base || '', r, n, i, d, kind, seq });
      };

      const mkLabelNR = (c) => c.includes('— Básico') ? c.replace('— Básico','— No Remunerativo') : c;
      const mkLabelIND = (c) => (/indem/i.test(c) || /indemn/i.test(c)) ? c : (c + ' (Indem.)');

      // Etiquetas claras para conceptos que se repiten (Rem/NR)
      const tagRemNR = (c, kind) => {
        const k = (kind || '').toUpperCase();
        if(/\(Rem\)|\(NR\)/i.test(c)) return c;
        if(/—\s*Remunerativo|—\s*No\s*Remunerativo/i.test(c)) return c;
        if(/^Antigüedad\b/i.test(c)) return c.replace(/^Antigüedad\b/i, `Antigüedad (${k==='REM'?'Rem':'NR'})`);
        if(/^Presentismo\b/i.test(c)) return c.replace(/^Presentismo\b/i, `Presentismo (${k==='REM'?'Rem':'NR'})`);
        return c;
      };

      for(const it of merged.sort((a,b)=>a.seq-b.seq)){
        const c = it.concepto;
        const base = it.base;
        const r = it.r, n = it.n, i = it.i, d = it.d;

        const hasR = Math.abs(r) > 1e-6;
        const hasN = Math.abs(n) > 1e-6;
        const hasI = Math.abs(i) > 1e-6;
        const hasD = Math.abs(d) > 1e-6;

        // En LF preferimos mostrar base en cada fila (Ver base), así no quedan conceptos sin base.
        if(hasR){
          pushRow(tagRemNR(c, 'REM'), base, r, 0, 0, 0, 'REM', it.seq);
        }
        if(hasN){
          pushRow(tagRemNR(mkLabelNR(c), 'NR'), base, 0, n, 0, 0, 'NR', it.seq);
        }
        if(hasI){
          pushRow(mkLabelIND(c), base, 0, 0, i, 0, 'IND', it.seq);
        }
        if(hasD){
          pushRow(c, base, 0, 0, 0, d, 'DED', it.seq);
        }
      }

      // 3) Orden final: Rem -> NR -> Ind -> Deducciones
      const order = { REM:1, NR:2, IND:3, DED:4 };
      rows.sort((a,b)=>{
        const oa = order[a.kind] || 9;
        const ob = order[b.kind] || 9;
        if(oa !== ob) return oa - ob;
        return (a.seq || 0) - (b.seq || 0);
      });

      // 4) Render (columna unificada: NR/Indemnizatorio)
      const addRowFinal = (c, base, r, ni, d) => {
        const tr = document.createElement('tr');

        const tdC = document.createElement('td');
        const baseHtml = base ? `<div class="muted lf-base" style="font-size:11px;">Base: ${escapeHtml(base)}</div>` : '';
        tdC.innerHTML = escapeHtml(c) + baseHtml;
        tr.appendChild(tdC);

        const tdR = document.createElement('td'); tdR.className='right'; tdR.textContent = money(r||0); tr.appendChild(tdR);
        const tdNI = document.createElement('td'); tdNI.className='right'; tdNI.textContent = money(ni||0); tr.appendChild(tdNI);
        const tdD = document.createElement('td'); tdD.className='right'; tdD.textContent = money(d||0); tr.appendChild(tdD);

        tbody.appendChild(tr);
      };

      let totRem = 0, totNRI = 0, totDed = 0;
      for(const rw of rows){
        const r = Number(rw.r || 0) || 0;
        const ni = (Number(rw.n || 0) || 0) + (Number(rw.i || 0) || 0);
        const d = Number(rw.d || 0) || 0;
        totRem = totRem + r;
        totNRI = totNRI + ni;
        totDed = totDed + d;
        addRowFinal(rw.concepto, rw.base, r, ni, d);
      }

      setText('lf_totRem', money(totRem));
      setText('lf_totNRI', money(totNRI));
      setText('lf_totDed', money(totDed));
      setText('lf_neto', money(totRem + totNRI - totDed));

//
      // Completar auxiliares
      if($('lf_anios') && data.anios_antig!=null) $('lf_anios').value = String(data.anios_antig);
      if($('lf_vac_anuales') && data.vac_anuales!=null) $('lf_vac_anuales').value = String(data.vac_anuales);
      if($('lf_vac_no_goz') && data.vac_no_gozadas_dias!=null && !($('lf_vac_no_goz').dataset.manual)) $('lf_vac_no_goz').value = String(Number(data.vac_no_gozadas_dias).toFixed(2));

      // Encabezado
      setText('lf_outRama', data.rama || rama);
      setText('lf_outAgrup', data.agrup || agrup);
      setText('lf_outCat', data.categoria || categoria);
      setText('lf_outIngreso', fmtDateISO(fi));
      setText('lf_outEgreso', fmtDateISO(fe));

      // Guardar para re-render si se necesita
      window.__lastFinalCalc = data;

      setText('diagFinal', 'Calculado.');

    }catch(err){
      console.error(err);
      alert('Error al calcular Liquidación Final (API).');
      setText('diagFinal', 'Error al calcular.');
    }
  };

  document.addEventListener('DOMContentLoaded', async () => {
    try{
      wire();
      await loadMeta();
      try{ window.lf_autofill_mejor && window.lf_autofill_mejor(); }catch(_){ }
    }catch(err){
      console.error(err);
      setText('status', 'Error al cargar maestro.');
      alert('Error al cargar maestro (meta). Ver consola.');
    }
  });

})();
</script></body>
</html>
