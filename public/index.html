<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8">
<title>Recibo de Sueldo</title>
<style>
:root{ --bg:#f6f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --pri:#2563eb; }
*{ box-sizing:border-box }
body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink); }
.container{ max-width:1100px; margin:16px auto; padding:16px; }
.card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px 14px 10px; box-shadow:0 6px 22px rgba(17,24,39,.06); }
h1{ font-size:18px; margin:0 0 10px 0; }
.grid{ display:grid; grid-template-columns: repeat(12,1fr); gap:10px; }
.field{ grid-column: span 3; }
.field.w2{ grid-column: span 2; }
.field.w4{ grid-column: span 4; }
label{ display:block; font-size:12px; color:var(--muted); margin:0 0 4px 0; }
select, input{ width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:10px; font-size:13px; background:#fff; }
small{ color:var(--muted); }
.row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
button{ padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; font-weight:600; }
button.primary{ background:var(--pri); border-color:var(--pri); color:#fff; }
hr{ border:none; border-top:1px solid var(--line); margin:12px 0; }
.table{ width:100%; border-collapse:collapse; font-size:13px; }
.table th, .table td{ border-bottom:1px solid var(--line); padding:8px 6px; vertical-align:top; }
.table th{ text-align:left; font-size:12px; color:var(--muted); font-weight:700; }
.num{ text-align:right; white-space:nowrap; }
.totals{ display:flex; gap:14px; justify-content:flex-end; margin-top:8px; flex-wrap:wrap; }
.pill{ border:1px solid var(--line); border-radius:999px; padding:6px 10px; background:#fff; font-weight:700; }
.no-print{ }
@media print{
  body{ background:#fff; }
  .no-print{ display:none !important; }
  .card{ box-shadow:none; border:none; }
}
.hide-base-col .base-col{ display:none !important; }
</style>
</head>

<body>
<div class="container">
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <h1>Recibo de Sueldo (Prueba)</h1>
      <div class="row no-print">
        <label style="display:flex;align-items:center;gap:6px;margin:0">
          <input id="toggleBase" type="checkbox">
          <span style="font-size:12px;color:var(--muted)">Ver base</span>
        </label>
        <span id="status" style="font-size:12px;color:var(--muted)">—</span>
      </div>
    </div>

    <div class="grid no-print">
      <div class="field w4">
        <label>Rama</label>
        <select id="rama"></select>
      </div>
      <div class="field w4">
        <label>Agrupamiento</label>
        <select id="agrup"></select>
      </div>
      <div class="field w4">
        <label>Categoría</label>
        <select id="categoria"></select>
      </div>

      <div class="field w2">
        <label>Mes</label>
        <select id="mes"></select>
      </div>
      <div class="field w2">
        <label>Hs (jornada)</label>
        <input id="hs" type="number" value="48" min="1" step="1">
      </div>
      <div class="field w2">
        <label>Años antigüedad</label>
        <input id="anios" type="number" value="0" min="0" step="1">
      </div>
      <div class="field w2">
        <label>Alta (para auto-antigüedad)</label>
        <input id="alta" type="date"/>
      </div>
      <div class="field w2">
        <label>Zona</label>
        <input id="zona" type="number" value="0" step="0.01">
      </div>

      <div class="field w2">
        <label>Ausencias injust.</label>
        <input id="coAus" type="number" value="0" min="0" step="1">
      </div>

      <div class="field w2">
        <label>Feriados no trabaj.</label>
        <input id="ferNoTrab" type="number" value="0" min="0" step="1">
      </div>
      <div class="field w2">
        <label>Feriados trabaj.</label>
        <input id="ferTrab" type="number" value="0" min="0" step="1">
      </div>
      <div class="field w2">
        <label>HE 50%</label>
        <input id="hex50" type="number" value="0" min="0" step="1">
      </div>
      <div class="field w2">
        <label>HE 100%</label>
        <input id="hex100" type="number" value="0" min="0" step="1">
      </div>
      <div class="field w2">
        <label>Hs Noct.</label>
        <input id="hsNoct" type="number" value="0" min="0" step="1">
      </div>

      <div class="field w2">
        <label>Obra Social</label>
        <select id="osecac">
          <option value="si">OSECAC (Sí)</option>
          <option value="no">No OSECAC</option>
        </select>
      </div>
      <div class="field w2">
        <label>Afiliado Sindicato</label>
        <select id="afiliadoSel">
          <option value="no">No</option>
          <option value="si">Sí</option>
        </select>
      </div>

      <div class="field w4">
        <label>Info</label>
        <div class="row" style="gap:8px">
          <button onclick="autocalcularAntiguedad()" type="button">Autocalcular antigüedad</button>
        </div>
        <small id="selInfo"></small>
      </div>
    </div>

    <div class="no-print" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
      <button onclick="calcularMensual()" class="primary" type="button">Calcular mensual</button>
      <button onclick="calcularFinal()" type="button">Calcular Liquidación Final</button>
      <button onclick="window.print()" type="button">Imprimir</button>
    </div>

    <hr>

    <div id="paneMensual">
      <table class="table">
        <thead>
          <tr>
            <th>Concepto</th>
            <th class="num base-col">Base</th>
            <th class="num">Rem.</th>
            <th class="num">No Rem.</th>
            <th class="num">Deducciones</th>
          </tr>
        </thead>
        <tbody id="tbodyMensual"></tbody>
      </table>

      <div class="totals">
        <div class="pill">Rem: <span id="totRem">$0</span></div>
        <div class="pill">No Rem: <span id="totNR">$0</span></div>
        <div class="pill">Ded: <span id="totDed">$0</span></div>
        <div class="pill">Neto: <span id="neto">$0</span></div>
      </div>
    </div>

    <div id="paneFinal" style="display:none">
      <table class="table">
        <thead>
          <tr>
            <th>Concepto</th>
            <th class="num base-col">Base</th>
            <th class="num">Rem.</th>
            <th class="num">No Rem.</th>
            <th class="num">Deducciones</th>
          </tr>
        </thead>
        <tbody id="tbodyFinal"></tbody>
      </table>

      <div class="totals">
        <div class="pill">Rem: <span id="lf_totRem">$0</span></div>
        <div class="pill">No Rem: <span id="lf_totNR">$0</span></div>
        <div class="pill">Ded: <span id="lf_totDed">$0</span></div>
        <div class="pill">Neto: <span id="lf_neto">$0</span></div>
      </div>
    </div>

  </div>
</div>

<script>
  // ---- Endpoints ----
  const API_BASE = location.origin;
  const ENDPOINT_META    = `${API_BASE}/meta`;
  const ENDPOINT_PAYLOAD = `${API_BASE}/payload`;
  const ENDPOINT_CALC    = `${API_BASE}/calcular`;

  // ---- Helpers ----
  const $ = (id) => document.getElementById(id);
  const num = (id, dflt=0) => {
    const el = $(id);
    if (!el) return dflt;
    const v = (el.value ?? "").toString().replace(",", ".").trim();
    const n = Number(v);
    return Number.isFinite(n) ? n : dflt;
  };
  const val = (id) => {
    const el = $(id);
    return el ? (el.value ?? "").toString().trim() : "";
  };
  const chk = (id) => {
    const el = $(id);
    return !!(el && el.checked);
  };

  const money = (x) => {
    const n = Number(x);
    const v = Number.isFinite(n) ? n : 0;
    return v.toLocaleString("es-AR", { style:"currency", currency:"ARS", minimumFractionDigits:2, maximumFractionDigits:2 });
  };

  function setText(id, txt) {
    const el = $(id);
    if (el) el.textContent = txt;
  }
  function setStatus(txt){ setText("status", txt); }

  function setValue(id, v) {
    const el = $(id);
    if (el) el.value = v;
  }

  function isDateLike(x){
    const s = String(x||"").trim();
    return /^\d{4}-\d{2}(-\d{2})?$/.test(s);
  }

  function fillSelect(sel, items, placeholder){
    if(!sel) return;
    const cur = sel.value;
    sel.innerHTML = "";
    const ph = document.createElement("option");
    ph.value = "";
    ph.textContent = placeholder || "—";
    sel.appendChild(ph);
    (items||[]).forEach(it=>{
      const o=document.createElement("option");
      o.value = it.value;
      o.textContent = it.label;
      sel.appendChild(o);
    });
    if(cur && Array.from(sel.options).some(o=>o.value===cur)) sel.value = cur;
  }

  // ---- State ----
  let META = null;
  let PAYLOAD_ROWS = [];
  let TREE = null;

  async function fetchJSON(url, data){
    const hasData = (data && typeof data === "object");
    const opt = hasData ? {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(data)
    } : undefined;

    const r = await fetch(url, opt);
    if(!r.ok){
      const t = await r.text();
      throw new Error(`HTTP ${r.status} ${t}`);
    }
    return r.json();
  }

  // ---- Tree builder (from rows) ----
  function buildTree(rows){
    const t = {};
    (rows||[]).forEach(r=>{
      const rama = String(r.rama||"").trim();
      const agrup = String(r.agrup||"—").trim() || "—";
      const cat = String(r.categoria||"—").trim() || "—";
      const mes = String(r.mes||"").trim();
      if(!rama || !mes) return;
      if(!t[rama]) t[rama] = { agrups:{} };
      if(!t[rama].agrups[agrup]) t[rama].agrups[agrup] = { cats:[], mesesByCat:{} };
      if(!t[rama].agrups[agrup].cats.includes(cat)) t[rama].agrups[agrup].cats.push(cat);
      if(!t[rama].agrups[agrup].mesesByCat[cat]) t[rama].agrups[agrup].mesesByCat[cat] = [];
      if(!t[rama].agrups[agrup].mesesByCat[cat].includes(mes)) t[rama].agrups[agrup].mesesByCat[cat].push(mes);
    });
    // sort
    Object.keys(t).forEach(r=>{
      Object.keys(t[r].agrups).forEach(a=>{
        t[r].agrups[a].cats.sort((x,y)=>x.localeCompare(y,"es"));
        Object.keys(t[r].agrups[a].mesesByCat).forEach(c=>{
          t[r].agrups[a].mesesByCat[c].sort((x,y)=>x.localeCompare(y,"es"));
        });
      });
    });
    return t;
  }

  async function reloadTreeForRamaMes(rama, mes){
    if(!rama || !mes) return;
    const url = new URL(ENDPOINT_PAYLOAD, window.location.href);
    url.searchParams.set("rama", String(rama));
    url.searchParams.set("mes", String(mes));
    const payload = await fetchJSON(url.toString());
    PAYLOAD_ROWS = payload.rows || [];
    TREE = buildTree(PAYLOAD_ROWS);
  }

  // ---- UI refresh ----
  function refreshSelectors() {
    if (!META) return;

    const ramaSel = $("rama");
    const agrupSel = $("agrup");
    const catSel = $("categoria");
    const mesSel = $("mes");

    // Ramas
    let ramas = [];
    if (Array.isArray(META.ramas)) ramas = META.ramas.slice();
    else if (META.ramas_dict) ramas = Object.keys(META.ramas_dict);
    else if (META.ramas) ramas = Object.keys(META.ramas);

    ramas = (ramas || [])
      .map(r => String(r || "").trim())
      .filter(r => r && !isDateLike(r) && !/^(?:\d+|\d+\.\d+)$/.test(r))
      .sort((a,b)=>a.localeCompare(b, "es"));

    fillSelect(ramaSel, ramas.map(r => ({ value:r, label:r })), "— Seleccione —");

    const curRama = ramaSel.dataset.last || ramaSel.value || (ramas.includes("GENERAL") ? "GENERAL" : (ramas[0] || ""));
    if (ramas.includes(curRama)) ramaSel.value = curRama;

    function refreshAgrup() {
      const r = ramaSel.value;
      ramaSel.dataset.last = r;

      const agrups = (TREE && TREE[r]) ? Object.keys(TREE[r].agrups || {}).sort((a,b)=>a.localeCompare(b, "es")) : [];
      fillSelect(agrupSel, agrups.map(a => ({ value:a, label:a })), "—");

      const curA = agrupSel.dataset.last || agrupSel.value || (agrups[0] || "—");
      if (curA && Array.from(agrupSel.options).some(o=>o.value===curA)) agrupSel.value = curA;
      refreshCat();
    }

    function refreshCat() {
      const r = ramaSel.value;
      const a = agrupSel.value || "—";
      agrupSel.dataset.last = a;

      const cats = (TREE && TREE[r] && TREE[r].agrups && TREE[r].agrups[a]) ? (TREE[r].agrups[a].cats || []) : [];
      fillSelect(catSel, cats.map(c => ({ value:c, label:c })), "—");

      const curC = catSel.dataset.last || catSel.value || (cats[0] || "");
      if (curC && Array.from(catSel.options).some(o=>o.value===curC)) catSel.value = curC;
      refreshMes();
    }

    function refreshMes() {
      const r = ramaSel.value;
      const a = agrupSel.value || "—";
      const c = catSel.value || "";
      catSel.dataset.last = c;

      let meses = [];
      if (TREE && TREE[r] && TREE[r].agrups && TREE[r].agrups[a] && TREE[r].agrups[a].mesesByCat && TREE[r].agrups[a].mesesByCat[c]) {
        meses = TREE[r].agrups[a].mesesByCat[c].slice();
      } else {
        // fallback a META.meses filtrado
        const mesesAll = Array.isArray(META?.meses) ? META.meses.map(x=>String(x||"").trim()).filter(Boolean) : [];
        meses = mesesAll.filter(m => m >= "2026-01");
        if(!meses.length) meses = mesesAll;
      }

      // filtro desde 2026-01
      const mesesFil = meses.filter(m => m >= "2026-01");
      if(mesesFil.length) meses = mesesFil;

      meses.sort((x,y)=>x.localeCompare(y,"es"));
      fillSelect(mesSel, meses.map(m => ({ value:m, label:m })), "—");

      const curM = mesSel.dataset.last || mesSel.value || (meses[0] || "");
      if (curM && Array.from(mesSel.options).some(o=>o.value===curM)) mesSel.value = curM;

      // Info
      setText("selInfo", `${ramaSel.value} · ${agrupSel.value||"—"} · ${catSel.value||"—"} · ${mesSel.value||"—"}`);
    }

    // handlers (con recarga de TREE)
    ramaSel.onchange = async () => {
      try{
        const mesesAll = Array.isArray(META?.meses) ? META.meses.map(x=>String(x||"").trim()).filter(Boolean) : [];
        const mesesFil = mesesAll.filter(m => m >= "2026-01");
        if(!mesSel.value) mesSel.value = (mesesFil[0] || mesesAll[0] || "");
        await reloadTreeForRamaMes(ramaSel.value, mesSel.value);
        refreshAgrup();
        toggleRamaBlocks();
        fetchAutoBase();
      }catch(e){ console.error(e); }
    };
    agrupSel.onchange = refreshCat;
    catSel.onchange = refreshMes;
    mesSel.onchange = async () => {
      try{
        mesSel.dataset.last = mesSel.value;
        await reloadTreeForRamaMes(ramaSel.value, mesSel.value);
        refreshAgrup();
        toggleRamaBlocks();
        fetchAutoBase();
      }catch(e){ console.error(e); }
    };

    refreshAgrup();
  }

  function toggleRamaBlocks(){
    // alterna pestañas si querés; por defecto mostramos mensual
    $("paneMensual").style.display = "";
    $("paneFinal").style.display = "none";
  }

  // ---- Payload builders (ya estaban en tu archivo) ----
  function buildPayloadMensual() {
    const coAus = num("coAus");
    return {
      rama: val("rama"),
      agrup: val("agrup") || "—",
      categoria: val("categoria"),
      mes: val("mes"),
      hs: num("hs") || 48,
      anios: num("anios") || 0,
      presentismo: (coAus <= 1),
      basico: num("basico"),
      zona: num("zona"),
      afiliado: (val("afiliadoSel") === "si"),
      osecac: (val("osecac").toLowerCase().includes("no") ? "no" : "si"),
      ferNoTrab: num("ferNoTrab"),
      ferTrab: num("ferTrab"),
      hex50: num("hex50"),
      hex100: num("hex100"),
      hsNoct: num("hsNoct"),
    };
  }

  function buildPayloadFinal(){
    // si tu backend la usa, completalo; por ahora deja lo básico
    return {
      rama: val("rama"),
      agrup: val("agrup") || "—",
      categoria: val("categoria"),
      mes: val("mes"),
      hs: num("hs") || 48,
      anios: num("anios") || 0,
    };
  }

  function clearTbody(id){
    const tb = $(id);
    if(tb) tb.innerHTML = "";
  }
  function addRow(tbodyId, concepto, base, rem, nr, ded){
    const tb = $(tbodyId);
    if(!tb) return;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${concepto}</td>
      <td class="num base-col">${base ?? ""}</td>
      <td class="num">${rem ?? ""}</td>
      <td class="num">${nr ?? ""}</td>
      <td class="num">${ded ?? ""}</td>
    `;
    tb.appendChild(tr);
  }

  // ---- Server calculation renderer ----
  async function postCalculo(payload, tbodyId, totRemId, totNrId, totDedId, totNetoId){
    clearTbody(tbodyId);

    const url = new URL(`${API_BASE}/calcular`, window.location.href);
    url.searchParams.set("rama", payload.rama);
    url.searchParams.set("agrup", payload.agrup || "—");
    url.searchParams.set("categoria", payload.categoria || "—");
    url.searchParams.set("mes", payload.mes);

    // extras
    url.searchParams.set("jornada", String(payload.hs || num("hs",48)));
    url.searchParams.set("anios", String(payload.anios || num("anios",0)));
    url.searchParams.set("zona", String(payload.zona || num("zona",0)));
    url.searchParams.set("osecac", String(payload.osecac || val("osecac") || "si"));
    url.searchParams.set("afiliado", String(payload.afiliado ? "si" : "no"));

    const data = await fetchJSON(url.toString());

    const items = data.items || [];
    items.forEach(it=>{
      addRow(tbodyId,
        it.concepto || "",
        (it.base != null ? money(it.base) : ""),
        (it.rem  != null ? money(it.rem)  : ""),
        (it.nr   != null ? money(it.nr)   : ""),
        (it.ded  != null ? money(it.ded)  : "")
      );
    });

    const tot = data.totales || {};
    if($(totRemId)) $(totRemId).textContent = money(tot.rem || 0);
    if($(totNrId)) $(totNrId).textContent  = money(tot.nr || 0);
    if($(totDedId)) $(totDedId).textContent = money(tot.ded || 0);
    if($(totNetoId)) $(totNetoId).textContent= money(tot.neto || 0);

    return data;
  }

  // -------- Handlers públicos --------
  window.calcularMensual = async function() {
    try {
      const payload = buildPayloadMensual();
      await postCalculo(payload, "tbodyMensual", "totRem", "totNR", "totDed", "neto");
    } catch (e) {
      console.error(e);
      alert("Error al calcular (API). Revisá conexión o datos.");
    }
  };

  window.calcularFinal = async function() {
    try {
      const payload = buildPayloadFinal();
      await postCalculo(payload, "tbodyFinal", "lf_totRem", "lf_totNR", "lf_totDed", "lf_neto");
    } catch (e) {
      console.error(e);
      alert("Error al calcular Liquidación Final (API).");
    }
  };

  window.autocalcularAntiguedad = function(){
    const alta = val("alta");
    if(!alta){ alert("Cargá la fecha de alta."); return; }
    const mes = val("mes");
    if(!mes){ alert("Seleccioná el mes."); return; }
    // calculo simple: años completos al último día del mes seleccionado
    const [yy,mm] = mes.split("-").map(Number);
    const fin = new Date(yy, (mm||1), 0); // último día del mes
    const ini = new Date(alta + "T00:00:00");
    let years = fin.getFullYear() - ini.getFullYear();
    const mDiff = fin.getMonth() - ini.getMonth();
    if(mDiff < 0 || (mDiff === 0 && fin.getDate() < ini.getDate())) years--;
    if(years < 0) years = 0;
    setValue("anios", String(years));
  };

  async function fetchAutoBase(){
    // opcional: si tu backend devuelve base sugerida, podés usarlo
    return;
  }

  // ---- Boot ----
  async function boot() {
    try {
      document.body.classList.add("hide-base-col");
      setStatus("Cargando maestro…");

      META = await fetchJSON(ENDPOINT_META);

      // 1) Poblamos Ramas primero
      TREE = {}; PAYLOAD_ROWS = [];
      refreshSelectors();

      // 2) Defaults: GENERAL + primer mes >= 2026-01
      const ramaSel = $("rama");
      const mesSel  = $("mes");

      const ramas = Array.isArray(META?.ramas) ? META.ramas : [];
      const defRama = ramas.includes("GENERAL") ? "GENERAL" : (ramas[0] || "");
      if (defRama) ramaSel.value = defRama;

      const mesesAll = Array.isArray(META?.meses) ? META.meses.map(x=>String(x||"").trim()).filter(Boolean) : [];
      const mesesFil = mesesAll.filter(m => m >= "2026-01");
      const defMes = (mesesFil[0] || mesesAll[0] || "");
      if (defMes) mesSel.value = defMes;

      // 3) Cargamos /payload?rama&mes
      if (ramaSel.value && mesSel.value) {
        await reloadTreeForRamaMes(ramaSel.value, mesSel.value);
      }

      // 4) Refrescamos selects con TREE real
      refreshSelectors();
      toggleRamaBlocks();

      // Toggle "Ver base"
      const baseChk = $("toggleBase");
      if (baseChk) {
        baseChk.addEventListener("change", () => {
          if (baseChk.checked) document.body.classList.remove("hide-base-col");
          else document.body.classList.add("hide-base-col");
        });
      }

      setStatus("Maestro cargado.");
    } catch (e) {
      console.error(e);
      alert("No se pudo cargar el maestro desde el servidor.");
      setStatus("Sin conexión");
    }
  }

  document.addEventListener("DOMContentLoaded", boot);
</script>

</body>
</html>
