<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Liquidación Comercio</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#f4f6fb;padding:20px}
select,button{padding:6px;width:100%}
.row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.box{background:#fff;padding:15px;border-radius:6px}
</style>
</head>
<body>

<h2>Liquidación de Haberes</h2>

<div class="box">
  <div class="row">
    <select id="rama"></select>
    <select id="agrup"></select>
    <select id="categoria"></select>
    <select id="mes"></select>
  </div>
  <br>
  <button onclick="calcularMensual()">Calcular</button>
  <div id="status"></div>
</div>

<script>
const API = "https://motor-sueldos-faecys.onrender.com";

const $ = id => document.getElementById(id);

const fetchJSON = async url => {
  const r = await fetch(url);
  if(!r.ok) throw await r.json();
  return r.json();
};

function getSelectedValue(id){
  const el = $(id);
  return el ? el.value : "";
}

let META = null;
let PAYLOAD = [];

function clearSelect(sel, txt="—"){
  sel.innerHTML = "";
  sel.append(new Option(txt,""));
}

function buildTree(rows){
  const tree = {};
  for(const r of rows){
    const rama = r.rama || r.RAMA;
    const agru = r.agrupamiento || r.AGRUPAMIENTO || r.agrup;
    const cat  = r.categoria || r.CATEGORIA;
    if(!rama||!agru||!cat) continue;
    tree[rama] ??= {};
    tree[rama][agru] ??= new Set();
    tree[rama][agru].add(cat);
  }
  return tree;
}

let TREE = {};

async function loadPayload(){
  const rama = getSelectedValue("rama");
  const mes  = getSelectedValue("mes");
  if(!rama || !mes) return;

  const data = await fetchJSON(`${API}/payload?rama=${rama}&mes=${mes}`);
  PAYLOAD = Array.isArray(data) ? data : (data.payload || data.rows || []);
  TREE = buildTree(PAYLOAD);

  refreshAgrup();
}

function refreshRamas(){
  clearSelect(rama);
  Object.keys(META.ramas).forEach(r=>rama.add(new Option(r,r)));
}

function refreshMeses(){
  clearSelect(mes);
  META.meses.forEach(m=>mes.add(new Option(m,m)));
  mes.selectedIndex = 1;
}

function refreshAgrup(){
  clearSelect(agrup);
  clearSelect(categoria);
  const r = getSelectedValue("rama");
  if(!TREE[r]) return;
  Object.keys(TREE[r]).forEach(a=>agrup.add(new Option(a,a)));
}

function refreshCategorias(){
  clearSelect(categoria);
  const r = getSelectedValue("rama");
  const a = getSelectedValue("agrup");
  if(!TREE[r]||!TREE[r][a]) return;
  [...TREE[r][a]].forEach(c=>categoria.add(new Option(c,c)));
}

async function boot(){
  try{
    $("status").textContent="Cargando…";
    META = await fetchJSON(`${API}/meta`);
    refreshRamas();
    refreshMeses();
    await loadPayload();
    $("status").textContent="Listo";
  }catch(e){
    console.error(e);
    $("status").textContent="Error al cargar maestro";
  }
}

rama.onchange = async ()=>{ await loadPayload(); };
mes.onchange  = async ()=>{ await loadPayload(); };
agrup.onchange = refreshCategorias;

async function calcularMensual(){
  const rama = getSelectedValue("rama");
  const agru = getSelectedValue("agrup");
  const cat  = getSelectedValue("categoria");
  const mesv = getSelectedValue("mes");
  if(!rama||!agru||!cat||!mesv){
    alert("Faltan selecciones");
    return;
  }
  const url = `${API}/calcular?rama=${rama}&agrup=${agru}&categoria=${cat}&mes=${mesv}&jornada=48&anios_antig=0&osecac=true&afiliado=false&sind_pct=0&titulo_pct=0`;
  const res = await fetchJSON(url);
  console.log("RESULTADO:",res);
  alert("Cálculo OK (ver consola)");
}

document.addEventListener("DOMContentLoaded",boot);
</script>

</body>
</html>
